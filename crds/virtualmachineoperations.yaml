apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: virtualmachineoperations.virtualization.deckhouse.io
  labels:
    heritage: deckhouse
    module: virtualization
spec:
  group: virtualization.deckhouse.io
  scope: Namespaced
  names:
    plural: virtualmachineoperations
    singular: virtualmachineoperation
    listKind: VirtualMachineOperationList
    kind: VirtualMachineOperation
    shortNames:
      - vmop
      - vmops
  preserveUnknownFields: false
  versions:
    - name: v1alpha2
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          description: |
            This resource provides the ability to declaratively manage state changes of virtual machines.
          required:
            - spec
          properties:
            spec:
              type: object
              required:
                - virtualMachineName
              properties:
                type:
                  type: string
                  enum: ["Start", "Stop", "Restart"]
                  description: |
                    Operation over the virtualmachine:
                    * Start - start the virtualmachine.
                    * Stop - stop the virtualmachine.
                    * Restart - restart the virtualmachine.
                virtualMachineName:
                  type: string
                  description: |
                    The name of the virtual machine for which the operation is performed.
                force:
                  type: boolean
                  description: |
                    Force the execution of the operation. Applies only for Restart and Stop. In this case, the action on the virtual machine is performed immediately.
              oneOf:
                - properties:
                    type:
                      enum: ["Start"]
                  required: ["virtualMachineName"]
                  not:
                    anyOf:
                      - required:
                          - force
                - properties:
                    type:
                      enum: ["Restart", "Stop"]
                  required: ["virtualMachineName"]
            status:
              description: |
                The latest observed state of the VirtualMachineOperation resource.
              type: object
              properties:
                conditions:
                  description: |
                    The latest detailed observations of the VirtualMachineOperation resource.
                  type: array
                  items:
                    type: object
                    properties:
                      lastProbeTime:
                        description: Last time the condition was checked.
                        format: date-time
                        type: string
                      lastTransitionTime:
                        description: Last time the condition transit from one status to another.
                        format: date-time
                        type: string
                      message:
                        description: Human readable message indicating details about last transition.
                        type: string
                      reason:
                        description: (brief) reason for the condition's last transition.
                        type: string
                      status:
                        description: Status of the condition, one of True, False, Unknown.
                        type: string
                        enum: ["True", "False", "Unknown"]
                      type:
                        description: Type of condition.
                        type: string
                    required:
                      - lastTransitionTime
                      - message
                      - reason
                      - status
                      - type
                phase:
                  type: string
                  description: |
                    Represents the current phase of resource:

                    * Pending - the operation is queued for execution.
                    * InProgress - operation in progress.
                    * Completed - the operation was successful.
                    * Failed - the operation failed. Check conditions and events for more information.
                    * Terminating - the operation is deleted.
                  enum:
                    - "Pending"
                    - "InProgress"
                    - "Completed"
                    - "Failed"
                    - "Terminating"
                observedGeneration:
                  type: integer
                  description: |
                    The generation last processed by the controller.
      additionalPrinterColumns:
        - name: Phase
          type: string
          jsonPath: .status.phase
        - name: VM
          jsonPath: .spec.virtualMachineName
          type: string
        - name: Age
          type: date
          jsonPath: .metadata.creationTimestamp
      subresources:
        status: {}
