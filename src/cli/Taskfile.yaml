# https://taskfile.dev

version: "3"

silent: true

tasks:
  build-tiny:
    desc: "Build d8v cli"
    cmds:
      - CGO_ENABLED=0 go build -o .out/d8v cmd/main.go

  build:
    desc: "Build d8v cli [CGO]"
    cmds:
      - mkdir -p .out
      - CGO_ENABLED=1 go build -tags cgo -o .out/d8v cmd/main.go

  install-tiny:
    desc: "Install d8v cli to ~/.local/bin"
    deps: [build-tiny]
    cmds:
      - _install

  install:
    desc: "Install d8v cli to ~/.local/bin [CGO]"
    deps: [build]
    cmds:
      - _install

  _install:
    internal: true
    cmds:
      - echo "Check that ~/.local/bin in your PATH"
      - echo "Installing d8v to ~/.local/bin"
      - mkdir -p ~/.local/bin
      - cp .out/d8v ~/.local/bin/d8v
      - task: clean

  clean:
    desc: "Clean up build artifacts"
    cmds:
      - rm -rf .out

  lint:
    desc: "Run linters locally"
    cmds:
      - task: lint:go

  lint:go:
    desc: "Run golangci-lint"
    deps:
      - _ensure:golangci-lint
    cmds:
      - |
        golangci-lint run

  _ensure:golangci-lint:
    desc: "Ensure golangci-lint is available"
    internal: true
    cmds:
      - |
        echo -e >&2 "Please install golangci-lint https://golangci-lint.run/usage/install/"
        exit 1
    status:
      - |
        [ -f ./golangci-lint ] || which golangci-lint
