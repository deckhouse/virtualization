name: Setup E2E Tools
description: Install kubectl, helm, d8, task, yq with caching

runs:
  using: composite
  steps:
    - name: Cache binaries
      uses: actions/cache@v4
      id: cache
      with:
        path: ~/.local/bin
        key: e2e-tools-${{ runner.os }}-v3

    - name: Ensure tools installed (install if missing or cache empty)
      shell: bash
      run: |
        set -euo pipefail
        mkdir -p ~/.local/bin

        need_install=false
        for bin in helm yq task; do
          if ! command -v "$bin" >/dev/null 2>&1; then
            echo "missing: $bin"; need_install=true
          fi
        done
        # Always (re)install kubectl into ~/.local/bin to shadow system kubectl
        need_install=true
        if [ "${need_install}" != "true" ] && [ "${{ steps.cache.outputs.cache-hit }}" = "true" ]; then
          echo "All tools present from cache, skipping install."
          exit 0
        fi

        # Install system dependencies
        sudo apt-get update
        sudo apt-get install -y jq apache2-utils curl bash ca-certificates

        # Install kubectl (always to ~/.local/bin)
        KUBECTL_VERSION=$(curl -Ls https://dl.k8s.io/release/stable.txt)
        curl -fsSL -o kubectl "https://dl.k8s.io/release/${KUBECTL_VERSION}/bin/linux/amd64/kubectl"
        chmod +x kubectl && mv kubectl ~/.local/bin/kubectl

        # Install helm
        curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
        if [ -x /usr/local/bin/helm ]; then mv /usr/local/bin/helm ~/.local/bin/; fi

        # Install d8
        curl -fsSL -o d8-install.sh https://raw.githubusercontent.com/deckhouse/deckhouse-cli/main/d8-install.sh
        bash d8-install.sh || true
        if [ -x /usr/local/bin/d8 ]; then cp -f /usr/local/bin/d8 ~/.local/bin/d8; fi

        # Install yq
        curl -L -o ~/.local/bin/yq https://github.com/mikefarah/yq/releases/download/v4.44.1/yq_linux_amd64
        chmod +x ~/.local/bin/yq

        # Install task
        sh -c "$(curl -fsSL https://taskfile.dev/install.sh)" -- -d -b ~/.local/bin

        # Cleanup
        rm -f d8-install.sh

    - name: Add to PATH
      shell: bash
      run: |
        echo "$HOME/.local/bin" >> $GITHUB_PATH
        echo "/usr/local/bin" >> $GITHUB_PATH

    - name: Verify installation
      shell: bash
      run: |
        echo "âœ… Installed tools:"
        which kubectl || true
        kubectl version --client=true --output=yaml || kubectl version || true
        which helm || true
        helm version --short || true
        which d8 || true
        d8 version || true
        which yq || true
        yq --version || true
        which task || true
        task --version || true
