# Copyright 2025 Flant JSC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: E2E Storage Matrix

on:
  push:
    branches:
      - ci-nested-matrix-test-run
  schedule:
    - cron: "30 2 * * *"
  workflow_dispatch:

permissions:
  contents: read

env:
  E2E_K8S_URL: https://api.e2e.virtlab.flant.com

jobs:
  setup:
    name: Setup (${{ matrix.profile }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - profile: sds-replicated-volume
            storage_name: sds
            storage_class: linstor-thin-r2
            parent_storage_class: linstor-thin-r1-immediate
            image_storage_class: linstor-thin-r1-immediate
            attach_disk_size: 10Gi
            data_disk_count: 2
    concurrency:
      group: setup-${{ github.head_ref || github.ref_name }}-${{ matrix.profile }}
      cancel-in-progress: true
    env:
      RUN_ID: nightly-nested-e2e-${{ matrix.storage_name }}-${{ github.run_number }}
      PROFILE: ${{ matrix.profile }}
      STORAGE_CLASS: ${{ matrix.storage_class }}
      PARENT_STORAGE_CLASS: ${{ matrix.parent_storage_class }}
      IMAGE_STORAGE_CLASS: ${{ matrix.image_storage_class }}
      ATTACH_DISK_SIZE: ${{ matrix.attach_disk_size }}
      DATA_DISK_COUNT: ${{ matrix.data_disk_count }}
    outputs:
      run_id: ${{ steps.setup-output.outputs.run_id }}
      run_artifact: ${{ steps.setup-output.outputs.run_artifact }}
      profile: ${{ steps.setup-output.outputs.profile }}
      storage_name: ${{ steps.setup-output.outputs.storage_name }}
      storage_class: ${{ steps.setup-output.outputs.storage_class }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Task
        uses: arduino/setup-task@v2
        with:
          version: 3.x
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Helm
        uses: azure/setup-helm@v4.3.0
        with:
          version: v3.17.2

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: "latest"

      - name: Setup d8
        uses: ./.github/actions/install-d8

      - name: Install yq
        run: |
          echo "Installing yq..."
          curl -L -o /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v4.44.1/yq_linux_amd64
          chmod +x /usr/local/bin/yq

      - name: Export setup outputs
        id: setup-output
        run: |
          set -euo pipefail
          echo "run_id=${RUN_ID}" >> "$GITHUB_OUTPUT"
          echo "run_artifact=nested-run-${RUN_ID}" >> "$GITHUB_OUTPUT"
          echo "profile=${PROFILE}" >> "$GITHUB_OUTPUT"
          echo "storage_name=${{ matrix.storage_name }}" >> "$GITHUB_OUTPUT"
          echo "storage_class=${STORAGE_CLASS}" >> "$GITHUB_OUTPUT"

      - name: Setup nested environment
        env:
          RUN_ID: ${{ env.RUN_ID }}
          PROFILE: ${{ env.PROFILE }}
          STORAGE_CLASS: ${{ env.STORAGE_CLASS }}
          PARENT_STORAGE_CLASS: ${{ env.PARENT_STORAGE_CLASS }}
          IMAGE_STORAGE_CLASS: ${{ env.IMAGE_STORAGE_CLASS }}
          ATTACH_DISK_SIZE: ${{ env.ATTACH_DISK_SIZE }}
          DATA_DISK_COUNT: ${{ matrix.data_disk_count }}
          REGISTRY_DOCKER_CFG: ${{ secrets.DEV_REGISTRY_DOCKER_CFG }}
          API_URL: ${{ env.E2E_K8S_URL }}
          SA_TOKEN: ${{ secrets.E2E_NESTED_SA_SECRET }}
        working-directory: ci/dvp-e2e
        run: |
          task ci:setup-nested-env

      - name: Upload nested artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.setup-output.outputs.run_artifact }}
          path: |
            ci/dvp-e2e/tmp/runs/${{ env.RUN_ID }}
          if-no-files-found: ignore

  tests:
    name: Run E2E (${{ matrix.profile }} / ${{ matrix.storage_class }})
    runs-on: ubuntu-latest
    needs: setup
    timeout-minutes: 300
    strategy:
      matrix:
        include:
          - profile: sds-replicated-volume
            storage_name: sds
            storage_class: linstor-thin-r2
            parent_storage_class: linstor-thin-r1-immediate
            image_storage_class: linstor-thin-r1-immediate
            attach_disk_size: 10Gi
            data_disk_count: 2
    env:
      GO_VERSION: "1.24.6"
      TIMEOUT: 4h
      RUN_ID: ${{ needs.setup.outputs.run_id }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go ${{ env.GO_VERSION }}
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install Task
        uses: arduino/setup-task@v2
        with:
          version: 3.x
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: "latest"

      - name: Setup d8
        uses: ./.github/actions/install-d8

      - name: Install ginkgo
        working-directory: test/e2e
        run: |
          go install github.com/onsi/ginkgo/v2/ginkgo@latest

      - name: Download dependencies
        working-directory: test/e2e
        run: |
          go mod download

      - name: Download nested run artifacts
        uses: actions/download-artifact@v4
        with:
          name: nested-run-${{ env.RUN_ID }}
          path: .

      - name: Configure kubeconfig env
        run: |
          set -euo pipefail
          NESTED_KUBECONFIG="${GITHUB_WORKSPACE}/ci/dvp-e2e/tmp/runs/${RUN_ID}/nested/kubeconfig"
          if [ ! -s "$NESTED_KUBECONFIG" ]; then
            echo "[ERR] Nested kubeconfig not found at $NESTED_KUBECONFIG" >&2
            exit 1
          fi
          echo "KUBECONFIG=$NESTED_KUBECONFIG" >> "$GITHUB_ENV"

      - name: Run E2E tests
        working-directory: test/e2e
        env:
          STORAGE_CLASS_NAME: ${{ matrix.storage_class }}
        run: |
          task run:ci -v

  cleanup:
    name: Cleanup (${{ matrix.profile }})
    needs:
      - setup
      - tests
    if: always()
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - profile: sds-replicated-volume
            storage_name: sds
            storage_class: linstor-thin-r2
            parent_storage_class: linstor-thin-r1-immediate
            image_storage_class: linstor-thin-r1-immediate
            attach_disk_size: 10Gi
            data_disk_count: 2
    steps:
      - uses: actions/checkout@v4

      - name: Install Task
        uses: arduino/setup-task@v2
        with:
          version: 3.x

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: "latest"

      - name: Cleanup test namespaces
        working-directory: ci/dvp-e2e
        run: |
          # Cleanup specific RUN_ID for this matrix leg
          RUN_ID="nightly-nested-e2e-${{ matrix.storage_name }}-${{ github.run_number }}"
          task cleanup:namespaces \
            PREFIX="${RUN_ID}" \
            API_URL="${E2E_K8S_URL}" \
            SA_TOKEN="${{ secrets.E2E_NESTED_SA_SECRET }}"
