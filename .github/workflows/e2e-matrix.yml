# Copyright 2025 Flant JSC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: E2E Matrix Tests (Skeleton)

on:
  push:
    branches:
      - chore/ci/e2e-matrix-skeleton
  pull_request:
    types: [opened, reopened, synchronize, labeled, unlabeled]
    branches:
      - main
      - chore/ci/e2e-matrix-skeleton
  schedule:
    - cron: "30 2 * * *"
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: e2e-matrix-${{ github.head_ref || github.ref_name }}
  cancel-in-progress: true

env:
  E2E_K8S_URL: https://api.e2e.virtlab.flant.com

jobs:
  # ============================================
  # 1. SETUP - Environment preparation
  # ============================================
  setup-nested-envs:
    name: Setup Nested Envs
    runs-on: ubuntu-latest
    concurrency:
      group: setup-nested-envs-${{ github.head_ref || github.ref_name }}
      cancel-in-progress: true
    outputs:
      run_id: ${{ steps.prep.outputs.run_id }}
      profile: ${{ steps.load.outputs.profile }}
    steps:
      - uses: actions/checkout@v4

      - name: Load storage profile
        id: load
        run: |
          cd ci/dvp-e2e
          # Map sds-replicated-volume to sds profile from profiles.json
          PROFILE=$(jq -r '.[0].name' profiles.json)
          echo "profile=$PROFILE" >> "$GITHUB_OUTPUT"
          echo "Will test profile: $PROFILE (mapped from sds-replicated-volume)"

      - name: Prepare run context
        id: prep
        run: |
          RUN_ID="nightly-nested-e2e-sds-$(date +%H%M%S)"
          PROFILE="${{ steps.load.outputs.profile }}"
          echo "run_id=$RUN_ID" >> "$GITHUB_OUTPUT"
          mkdir -p ./tmp/run-context
          {
            echo "profile: ${PROFILE}"
            echo "run_id: ${RUN_ID}"
            echo "timestamp: $(date -Iseconds)"
          } > ./tmp/run-context/config.yaml

  # ============================================
  # 2. PREPARE - Cluster preparation
  # ============================================
  prepare:
    name: Prepare Cluster
    needs: [setup-nested-envs]
    runs-on: ubuntu-latest
    timeout-minutes: 300
    concurrency:
      group: prepare-${{ github.head_ref || github.ref_name }}-${{ needs.setup-nested-envs.outputs.profile }}
      cancel-in-progress: true
    env:
      PROFILE: ${{ needs.setup-nested-envs.outputs.profile }}
      TMP_ROOT: ${{ github.workspace }}/ci/dvp-e2e/tmp
      REGISTRY_DOCKER_CFG: ${{ secrets.DEV_REGISTRY_DOCKER_CFG }}

    steps:
      - uses: actions/checkout@v4

      - name: Install Task
        uses: arduino/setup-task@v2
        with:
          version: 3.x
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Helm
        uses: azure/setup-helm@v4.3.0
        with:
          version: v3.17.2

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: "latest"

      - name: Setup d8
        uses: werf/trdl/actions/setup-app@v0.12.2
        with:
          repo: d8
          url: https://deckhouse.ru/downloads/deckhouse-cli-trdl/
          root-version: 1
          root-sha512: 343bd5f0d8811254e5f0b6fe292372a7b7eda08d276ff255229200f84e58a8151ab2729df3515cb11372dc3899c70df172a4e54c8a596a73d67ae790466a0491
          group: 0
          channel: stable

      - name: Install yq
        run: |
          echo "Installing yq..."
          curl -L -o /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v4.44.1/yq_linux_amd64
          chmod +x /usr/local/bin/yq

      - name: Prepare environment
        id: prep
        run: |
          RUN_ID="${{ needs.setup-nested-envs.outputs.run_id }}"
          echo "RUN_ID=$RUN_ID" >> "$GITHUB_ENV"
          echo "TMP_ROOT=${{ env.TMP_ROOT }}" >> "$GITHUB_ENV"
          mkdir -p "${{ env.TMP_ROOT }}/shared" "${{ env.TMP_ROOT }}/matrix-logs"

      - name: Build parent kubeconfig from secret
        working-directory: ci/dvp-e2e
        run: |
          KCFG="$HOME/.kube/config"
          task parent:kubeconfig OUTPUT="$KCFG" API_URL="${E2E_K8S_URL}" SA_TOKEN="${{ secrets.E2E_NESTED_SA_SECRET }}"
          echo "KUBECONFIG=$KCFG" >> "$GITHUB_ENV"

      - name: Prepare run values.yaml
        working-directory: ci/dvp-e2e
        run: |
          task run:values:prepare \
            RUN_ID="${{ env.RUN_ID }}" \
            RUN_NAMESPACE="${{ env.RUN_ID }}" \
            RUN_DIR="${{ env.TMP_ROOT }}/runs/${{ env.RUN_ID }}"

      - name: Configure registry auth for installer pull
        run: |
          mkdir -p ~/.docker
          printf '%s' "$REGISTRY_DOCKER_CFG" | base64 -d > ~/.docker/config.json

      - name: Configure storage profile
        working-directory: ci/dvp-e2e
        id: profile-config
        run: |
          PROFILE_JSON=$(jq -c --arg profile "$PROFILE" '.[] | select(.name == $profile)' profiles.json)
          if [ -z "$PROFILE_JSON" ]; then
            echo "Profile '$PROFILE' not found in profiles.json" >&2
            echo "Available profiles:" >&2
            jq -r '.[] | "  - \(.name)"' profiles.json >&2
            exit 1
          fi

          STORAGE_CLASS=$(jq -r '.storage_class // ""' <<<"$PROFILE_JSON")
          IMAGE_STORAGE_CLASS=$(jq -r '.image_storage_class // ""' <<<"$PROFILE_JSON")
          SNAPSHOT_STORAGE_CLASS=$(jq -r '.snapshot_storage_class // ""' <<<"$PROFILE_JSON")
          PARENT_STORAGE_CLASS=$(jq -r '.parent_storage_class // ""' <<<"$PROFILE_JSON")
          ATTACH_DISK_SIZE=$(jq -r '.worker_data_disk_size // "10Gi"' <<<"$PROFILE_JSON")

          echo "Profile: ${PROFILE}"
          echo "Storage Class: ${STORAGE_CLASS}"
          echo "Image Storage Class: ${IMAGE_STORAGE_CLASS}"
          echo "Snapshot Storage Class: ${SNAPSHOT_STORAGE_CLASS}"
          echo "Parent Storage Class: ${PARENT_STORAGE_CLASS}"
          echo "Attach Disk Size: ${ATTACH_DISK_SIZE}"

          # Export variables to GitHub Actions environment
          echo "STORAGE_CLASS=${STORAGE_CLASS}" >> $GITHUB_ENV
          echo "PARENT_STORAGE_CLASS=${PARENT_STORAGE_CLASS}" >> $GITHUB_ENV
          echo "ATTACH_DISK_SIZE=${ATTACH_DISK_SIZE}" >> $GITHUB_ENV
          # Pass storage profile into run values for Helm templates
          yq eval --inplace ".storageProfile = \"${PROFILE}\"" "${{ env.TMP_ROOT }}/runs/${{ env.RUN_ID }}/values.yaml"
          # Effective disk SC used for worker data disks (prefer image SC when set)
          EFF_DISK_SC=${IMAGE_STORAGE_CLASS:-$STORAGE_CLASS}
          echo "EFFECTIVE_DISK_SC=${EFF_DISK_SC}" >> $GITHUB_ENV

      - name: Install nested environment
        working-directory: ci/dvp-e2e
        run: |
          task install:nested:env \
            TMP_DIR="${{ env.TMP_ROOT }}/runs/${{ env.RUN_ID }}" \
            VALUES_FILE="${{ env.TMP_ROOT }}/runs/${{ env.RUN_ID }}/values.yaml" \
            PARENT_KUBECONFIG="${KUBECONFIG}" \
            TARGET_STORAGE_CLASS="${{ env.PARENT_STORAGE_CLASS }}" \
            ATTACH_DISK_SIZE="${{ env.ATTACH_DISK_SIZE }}" \
            EFFECTIVE_DISK_SC="${{ env.EFFECTIVE_DISK_SC }}" \
            NAMESPACE="${{ env.RUN_ID }}" \
            NESTED_KUBECONFIG="${{ env.TMP_ROOT }}/runs/${{ env.RUN_ID }}/nested/kubeconfig" \
            SDS_SC_NAME="${{ env.STORAGE_CLASS }}"

  cleanup:
    name: Cleanup [skeleton]
    needs: [setup-nested-envs, prepare]
    if: always()
    runs-on: ubuntu-latest
    env:
      CLEANUP_PREFIX: ${{ vars.CLEANUP_PREFIX || 'nightly-nested-e2e-' }}
    steps:
      - uses: actions/checkout@v4

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: "latest"

      - name: Install Task
        uses: arduino/setup-task@v2

      - name: Build parent kubeconfig from secret
        working-directory: ci/dvp-e2e
        run: |
          KCFG="$HOME/.kube/config"
          task parent:kubeconfig OUTPUT="$KCFG" API_URL="${E2E_K8S_URL}" SA_TOKEN="${{ secrets.E2E_NESTED_SA_SECRET }}"
          echo "KUBECONFIG=$KCFG" >> "$GITHUB_ENV"

      - name: Cleanup test namespaces
        working-directory: ci/dvp-e2e
        run: |
          task cleanup:namespaces PREFIX="${CLEANUP_PREFIX}" PARENT_KUBECONFIG="${KUBECONFIG}"

      - name: Report cleanup results
        if: always()
        run: |
          echo "### Cleanup Results" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Cleanup job completed" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ§¹ Attempted to clean up namespaces with prefix '${CLEANUP_PREFIX}'" >> $GITHUB_STEP_SUMMARY
