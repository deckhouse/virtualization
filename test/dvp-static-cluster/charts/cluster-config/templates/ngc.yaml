---
apiVersion: deckhouse.io/v1alpha1
kind: NodeGroupConfiguration
metadata:
  name: qemu-guest-agent-install-ubuntu.sh
spec:
  weight: 98
  nodeGroups: ["*"]
  bundles: ["ubuntu-lts", "debian", "astra"]
  content: |
    bb-apt-install qemu-guest-agent bash-completion
    systemctl enable --now qemu-guest-agent
---
apiVersion: deckhouse.io/v1alpha1
kind: NodeGroupConfiguration
metadata:
  name: d8-dm-modules.conf
spec:
  weight: 98
  nodeGroups: ["*"]
  bundles: ["astra", "ubuntu-lts", "debian"]
  content: |
    bb-sync-file /etc/modules-load.d/d8-dm-modules.conf - << "EOF"
    dm_snapshot
    dm_thin_pool
    dm_cache
    EOF

    systemctl restart systemd-modules-load.service
---
apiVersion: deckhouse.io/v1alpha1
kind: NodeGroupConfiguration
metadata:
  name: install-tools.sh
spec:
  weight: 98
  nodeGroups: ["*"]
  bundles: ["*"]
  content: |
    bb-sync-file /etc/profile.d/01-kubectl-aliases.sh - << "EOF"
    source <(/opt/deckhouse/bin/kubectl completion bash)
    alias k=kubectl
    complete -o default -F __start_kubectl k
    EOF

    if [ ! -f /usr/local/bin/k9s ]; then
      K9S_URL=$(curl -s https://api.github.com/repos/derailed/k9s/releases/latest | jq '.assets[] | select(.name=="k9s_Linux_amd64.tar.gz") | .browser_download_url' -r)
      curl -L "${K9S_URL}" | tar -xz -C  /usr/bin/ "k9s"
    fi

    if [ ! -f /usr/local/bin/stern ]; then
      STERN_URL=$(curl -s https://api.github.com/repos/stern/stern/releases/latest | jq '.assets[].browser_download_url | select(. | test("linux_amd64"))' -r)
      curl -L "${STERN_URL}" | tar -xz -C  /usr/bin/ "stern"
    fi
---
apiVersion: deckhouse.io/v1alpha1
kind: NodeGroupConfiguration
metadata:
  name: containerd-additional-registry-auth.sh
spec:
  bundles:
  - '*'
  content: |
    # Access to dev registry to install dev modules on prod cluster.

    bb-event-on 'containerd-config-changed' '_restart_containerd'
    _restart_containerd() {
        bb-flag-set containerd-need-restart
    }

    REGISTRY_URL="{{ .Values.discovered.registry_url }}"
    REGISTRY_AUTH="{{ .Values.discovered.registry_auth }}"

    {{"{{"}}- if eq .cri "ContainerdV2" {{"}}"}}

    mkdir -p "/etc/containerd/registry.d/${REGISTRY_URL}"

    bb-sync-file "/etc/containerd/registry.d/${REGISTRY_URL}/hosts.toml" - containerd-config-changed << EOF
    server = "https://${REGISTRY_URL}"
    [host."https://${REGISTRY_URL}"]
      capabilities = ["pull", "resolve"]
    [host."https://${REGISTRY_URL}".auth]
      auth = "${REGISTRY_AUTH}"
    EOF

    {{"{{"}}- else {{"}}"}}

    mkdir -p /etc/containerd/conf.d
    bb-sync-file /etc/containerd/conf.d/additional_registry.toml - containerd-config-changed << EOF
    [plugins]
      [plugins."io.containerd.grpc.v1.cri"]
        [plugins."io.containerd.grpc.v1.cri".registry.mirrors."${REGISTRY_URL}"]
          endpoint = ["https://${REGISTRY_URL}"]
        [plugins."io.containerd.grpc.v1.cri".registry.configs."${REGISTRY_URL}".auth]
          auth = "${REGISTRY_AUTH}"
    EOF

    {{"{{"}}- end {{"}}"}}
  nodeGroups:
  - '*'
  weight: 31
