{{- $totalNodes := .Values.instances.masterNodes.count -}}
{{- range .Values.instances.additionalNodes -}}
  {{- $totalNodes = add $totalNodes .count -}}
{{- end -}}

{{- if eq .Values.deckhouse.bundle "Default" }}
---
apiVersion: deckhouse.io/v1alpha1
kind: ModuleConfig
metadata:
  name: user-authn
spec:
  version: 2
  enabled: true
  settings:
    controlPlaneConfigurator:
      dexCAMode: DoNotNeed
    publishAPI:
      enabled: true
      https:
        mode: SelfSigned
        global:
          kubeconfigGeneratorMasterCA: ""
---
apiVersion: deckhouse.io/v1alpha1
kind: ModuleConfig
metadata:
  name: user-authz
spec:
  enabled: true
  version: 1
---
apiVersion: deckhouse.io/v1alpha1
kind: ModuleConfig
metadata:
  name: descheduler
spec:
  enabled: {{ if eq $totalNodes 1 }}false{{ else }}true{{ end }}

##################################################################
## observability
##################################################################
---
apiVersion: deckhouse.io/v1alpha1
kind: ModuleConfig
metadata:
  name: prometheus
spec:
  version: 1
  enabled: true
  settings:
    retentionDays: 7
    # storageClass: i-linstor-thin-r1
---
apiVersion: deckhouse.io/v1alpha1
kind: ModuleConfig
metadata:
  name: prompp
spec:
  version: 1
  enabled: true
---
apiVersion: deckhouse.io/v1alpha2
kind: ModulePullOverride
metadata:
  name: prompp
spec:
  imageTag: stable
  scanInterval: 15s
---
apiVersion: deckhouse.io/v1alpha1
kind: ModuleConfig
metadata:
  name: monitoring-applications
spec:
  enabled: true
---
apiVersion: deckhouse.io/v1alpha1
kind: ModuleConfig
metadata:
  name: node-local-dns
spec:
  enabled: true
---
apiVersion: deckhouse.io/v1alpha1
kind: ModuleConfig
metadata:
  name: log-shipper
spec:
  enabled: true
---
apiVersion: deckhouse.io/v1alpha1
kind: ModuleConfig
metadata:
  name: loki
spec:
  settings:
    # storageClass: i-linstor-thin-r1
    diskSizeGigabytes: 50
    retentionPeriodHours: 24
    storeSystemLogs: false
  enabled: true
  version: 1

##################################################################
## storage
##################################################################

---
apiVersion: deckhouse.io/v1alpha1
kind: ModuleConfig
metadata:
  name: snapshot-controller
spec:
  enabled: true
  version: 1
---
apiVersion: deckhouse.io/v1alpha2
kind: ModulePullOverride
metadata:
  name: snapshot-controller
spec:
  imageTag: main
  rollback: false
  scanInterval: 10m0s

{{ if or .Values.modules.sdsLocalVolumeEnabled .Values.modules.sdsReplicatedVolumeEnabled }}
---
apiVersion: deckhouse.io/v1alpha1
kind: ModuleConfig
metadata:
  name: sds-node-configurator
spec:
  version: 1
  enabled: true
---
apiVersion: deckhouse.io/v1alpha2
kind: ModulePullOverride
metadata:
  name: sds-node-configurator
spec:
  imageTag: main
  scanInterval: 15s
{{ end }}

{{ if .Values.modules.sdsReplicatedVolumeEnabled }}
---
apiVersion: deckhouse.io/v1alpha1
kind: ModuleConfig
metadata:
  name: sds-replicated-volume
spec:
  version: 1
  enabled: true
---
apiVersion: deckhouse.io/v1alpha2
kind: ModulePullOverride
metadata:
  name: sds-replicated-volume
spec:
  imageTag: main
  scanInterval: 15s
{{ end }}

##################################################################
## ingress
##################################################################
---
apiVersion: deckhouse.io/v1
kind: IngressNginxController
metadata:
  name: main
spec:
  inlet: HostPort
  enableIstioSidecar: true
  ingressClass: nginx
  hostPort:
    httpPort: 80
    httpsPort: 443
  nodeSelector:
    node-role.kubernetes.io/master: ''
  tolerations:
    - effect: NoSchedule
      operator: Exists

##################################################################
## rbac
##################################################################
---
apiVersion: deckhouse.io/v1
kind: ClusterAuthorizationRule
metadata:
  name: admin
spec:
  subjects:
    - kind: User
      name: admin@deckhouse.io
  accessLevel: SuperAdmin
  portForwarding: true
---
apiVersion: deckhouse.io/v1
kind: User
metadata:
  name: admin
spec:
  email: admin@deckhouse.io
  # echo "t3chn0l0gi4" | htpasswd -BinC 10 "" | cut -d: -f2 | base64 -w0
  password: {{ .Values.discovered.passwordHash }}
{{ end }}
