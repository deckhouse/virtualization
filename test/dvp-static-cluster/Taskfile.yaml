# https://taskfile.dev

version: "3"


vars:
  NAMESPACE:
    sh: yq eval '.namespace' values.yaml
  DECKHOUSE_TAG:
    sh: yq eval '.deckhouse.tag' values.yaml
  DEFAULT_USER:
    sh: yq eval '.image.defaultUser' values.yaml
  TMP_DIR: ./tmp
  SSH_DIR: "{{ .TMP_DIR }}/ssh"
  SSH_FILE_NAME: cloud
  SSH_PUB_KEY_FILE: "{{ .SSH_DIR }}/{{ .SSH_FILE_NAME }}.pub"
  SSH_PRIV_KEY_FILE: "{{ .SSH_DIR }}/{{ .SSH_FILE_NAME }}"
  DISCOVERED_VALUES_FILE: tmp/discovered-values.yaml
  PASSWORD_FILE: "{{ .TMP_DIR }}/password.txt"
  PASSWORD_HASH_FILE: "{{ .TMP_DIR }}/password-hash.txt"
tasks:
  create-tmp-dir:
    desc: Preflight / Create tmp dir
    cmds:
      - mkdir -p "{{ .TMP_DIR }}"
      - mkdir -p "{{ .SSH_DIR }}"
    status:
      - test -d "{{ .TMP_DIR }}"
      - test -d "{{ .SSH_DIR }}"

  ssh-gen:
    desc: Preflight / Generate ssh keypair for jump-host
    deps:
      - create-tmp-dir
    cmds:
      - ssh-keygen -t ed25519 -b 1024 -f {{ .SSH_PRIV_KEY_FILE }} -N "" -C "cloud"
      - chmod 0600 "{{ .SSH_PUB_KEY_FILE }}"
      - chmod 0400 "{{ .SSH_PRIV_KEY_FILE }}"
    status:
      - test -f "{{ .SSH_PRIV_KEY_FILE }}"

  password-gen:
    desc: Preflight / Generate password
    deps:
      - ssh-gen
    cmds:
      - date +%s | sha256sum | base64 | head -c 10 > {{ .PASSWORD_FILE }}
      - |
        echo $(cat {{ .TMP_DIR }}/password.txt) | htpasswd -BinC 10 "" | cut -d: -f2 | base64 -w0 > {{ .PASSWORD_HASH_FILE }}
    status:
      - test -f "{{ .PASSWORD_FILE }}"
      - test -f "{{ .PASSWORD_HASH_FILE }}"


  generate-helm-values:
    desc: Generate helm values {{ .DISCOVERED_VALUES_FILE }}
    deps:
    - password-gen
    cmds:
      - touch {{ .DISCOVERED_VALUES_FILE }}
      - |
        export SSH_PUB_KEY="$(cat {{ .SSH_PUB_KEY_FILE }})"
        yq eval --inplace '.discovered.publicSSHKey = env(SSH_PUB_KEY)' {{ .DISCOVERED_VALUES_FILE }}
      - |
        export SSH_PRIV_KEY_B64="$(cat {{ .SSH_PRIV_KEY_FILE }} | base64 -w 0)"
        yq eval --inplace '.discovered.privateSSHKeyBase64 = env(SSH_PRIV_KEY_B64)' {{ .DISCOVERED_VALUES_FILE }}
      - |
        export DOMAIN=$(kubectl get mc global -o json | jq '.spec.settings.modules.publicDomainTemplate | split(".")[1:] | join(".")' -rc)
        yq eval --inplace '.discovered.domain = env(DOMAIN)' {{ .DISCOVERED_VALUES_FILE }}
      - |
        export CLUSTER_DOMAIN=$(kubectl -n d8-system exec svc/deckhouse-leader -- deckhouse-controller global values -o json | jq -rc .clusterConfiguration.clusterDomain)
        yq eval --inplace '.discovered.clusterDomain = env(CLUSTER_DOMAIN)' {{ .DISCOVERED_VALUES_FILE }}
      - |
        export PASSWORD_HASH="$(cat {{ .PASSWORD_HASH_FILE }})"
        yq eval --inplace '.discovered.passwordHash = env(PASSWORD_HASH)' {{ .DISCOVERED_VALUES_FILE }}
  
  render-vm-ips:
    desc: Get VM IPs
    cmds:
      - |
        if kubectl -n {{ .NAMESPACE }} get vm -o name 2>/dev/null | grep -q .; then
          export VM_IPS=$(kubectl -n {{ .NAMESPACE }} get vm -o json | jq -r '[.items[] | select(.status.ipAddress != null) | .metadata.name + ": " + .status.ipAddress] | join("\n")')
          yq eval --inplace '.discovered.vmIPs = env(VM_IPS)' {{ .DISCOVERED_VALUES_FILE }}
        else
          yq eval --inplace '.discovered.vmIPs = {}' {{ .DISCOVERED_VALUES_FILE }}
        fi

  render-infra:
    desc: Preparation / Generate infra manifests
    deps:
    - generate-helm-values
    cmds:
    - helm template static-dvp-over-dvp-infra ./charts/infra -f values.yaml -f {{ .DISCOVERED_VALUES_FILE }} >> {{ .TMP_DIR }}/infra.yaml

  infra-deploy:
    deps:
      - render-infra
    desc: Deploy infra (Namespace/RBAC/Jumphost)
    vars:
      start_time:
        sh: date +%s
    cmds:
      - kubectl apply -f {{ .TMP_DIR }}/infra.yaml
      - kubectl -n {{ .NAMESPACE }} get all
      - kubectl -n {{ .NAMESPACE }} wait --for=condition=Ready pod -l app=jump-host --timeout=300s
      - kubectl -n {{ .NAMESPACE }} get vi -o name | xargs kubectl -n {{ .NAMESPACE }} wait --for='jsonpath={.status.phase}=Ready' --timeout=600s
      - kubectl -n {{ .NAMESPACE }} get vd -o name | xargs kubectl -n {{ .NAMESPACE }} wait --for='jsonpath={.status.phase}=Ready' --timeout=600s
      - kubectl -n {{ .NAMESPACE }} get vm -o name | xargs kubectl -n {{ .NAMESPACE }} wait --for='jsonpath={.status.phase}=Running' --timeout=600s
      - kubectl -n {{ .NAMESPACE }} get vm -o name | xargs kubectl -n {{ .NAMESPACE }} wait --for='jsonpath={.status.conditions[?(@.type=="AgentReady")].status}=True' --timeout=300s
      - |
        export end_time=$(date +%s)
        difference=$((end_time - {{.start_time}}))
        date -ud "@$difference" +'%H:%M:%S'
      - task: render-vm-ips

  infra-undeploy:
    desc: Destroy infra
    aliases:
    - uninstall
    cmds:
      - kubectl delete -f {{ .TMP_DIR }}/infra.yaml || true
      - kubectl wait --for=delete namespace/{{ .NAMESPACE }} --timeout 300s || true


  render-cluster-config:
    desc: Preparation / Generate cluster config (infra required)
    deps:
    - ssh-gen
    - generate-helm-values
    cmds:
    - helm template dvp-over-static-dvp-cluster-config ./charts/cluster-config -f values.yaml -f {{ .DISCOVERED_VALUES_FILE }} > {{ .TMP_DIR }}/config.yaml

  render-cluster-manifests:
    desc: Preparation / Generate cluster config without cluster bootstrap configs (infra required)
    deps:
    - render-cluster-config
    cmds:
    - yq 'select( (.apiVersion + "/" + .kind) != "deckhouse.io/v1/InitConfiguration" and (.apiVersion + "/" + .kind) != "deckhouse.io/v1/ClusterConfiguration" and (.apiVersion + "/" + .kind) != "deckhouse.io/v1/StaticClusterConfiguration" )' {{ .TMP_DIR }}/config.yaml > {{ .TMP_DIR }}/config-manifests.yaml

  render-all:
    desc: Generate all manifests
    cmds:
      - task render-infra
      - task render-cluster-config
      - task render-cluster-manifests

  # update-cluster:
  #   desc: Update cluster
  #   deps:
  #     - render-cluster-manifests
  #   cmds:
  #   - rsync -azv -e "ssh -i {{ .SSH_PRIV_KEY_FILE }} -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o 'ProxyCommand=d8 v port-forward --stdio=true master-0.{{ .NAMESPACE }} 22'" {{ .TMP_DIR }}/config-manifests.yaml {{ .DEFAULT_USER }}@master-0:/tmp/config-manifests.yaml
  #   - task: __ssh-command
  #     vars:
  #       CMD: sudo /opt/deckhouse/bin/kubectl apply -f /tmp/config-manifests.yaml

  dhctl-bootstrap:
    desc: Bootstrap DKP over DVP
    deps:
      - render-cluster-config
    vars:
      DeckhouseInstallImage: "dev-registry.deckhouse.io/sys/deckhouse-oss/install"
      prefix:
        sh: yq eval '.storage_type' values.yaml
      start_time:
        sh: date +%s
      JUMPHOST_EXT_IP:
        sh: kubectl -n {{ .NAMESPACE }} exec -it deployment/jump-host -- dig @resolver4.opendns.com myip.opendns.com +short
      JUMPHOST_NODEPORT:
        sh: kubectl -n {{ .NAMESPACE }} get svc jump-host -o json | jq '.spec.ports[] | select(.port==2222) | .nodePort'
      MASTER_NODE_IP:
        sh: kubectl -n {{ .NAMESPACE }} get vm {{.prefix}}-master-0 -o jsonpath="{.status.ipAddress}"
    cmds:
      - |
        docker run --pull=always \
        -v "{{ .TMP_DIR }}/config.yaml:/config.yaml" \
        -v "{{ .SSH_DIR }}:/tmp/.ssh/" \
        -v "{{ .TMP_DIR }}/dhctl:/tmp/dhctl/" \
        {{ .DeckhouseInstallImage }}:{{ .DECKHOUSE_TAG }} \
            dhctl bootstrap \
            --config=/config.yaml \
            --ssh-agent-private-keys=/tmp/.ssh/{{ .SSH_FILE_NAME }} \
            --ssh-host={{ .MASTER_NODE_IP }} \
            --ssh-user={{ .DEFAULT_USER }} \
              --ssh-bastion-port={{ .JUMPHOST_NODEPORT }} \
              --ssh-bastion-host={{ .JUMPHOST_EXT_IP }} \
              --ssh-bastion-user=user \
            {{.CLI_ARGS}}
      - |
        export end_time=$(date +%s)
        difference=$((end_time - {{.start_time}}))
        date -ud "@$difference" +'%H:%M:%S'

  show-connection-info:
    desc: Show connection info
    vars:
      DOMAIN:
        sh: yq eval '.discovered.domain' {{ .DISCOVERED_VALUES_FILE }}
      PASSWORD:
        sh: cat {{ .PASSWORD_FILE }}
      JUMPHOST_EXT_IP:
        sh: kubectl -n {{ .NAMESPACE }} exec -it deployment/jump-host -- dig @resolver4.opendns.com myip.opendns.com +short
      JUMPHOST_NODEPORT:
        sh: kubectl -n {{ .NAMESPACE }} get svc jump-host -o json | jq '.spec.ports[] | select(.port==2222) | .nodePort'
      MASTER_NODE_NAME:
        sh: kubectl get node -l node.deckhouse.io/group=master -o jsonpath="{.items[0].metadata.name}"

    silent: true
    cmds:
    - echo "Connect to master task ssh-to-master"
    - |
        echo "Host cluster master node: {{ .MASTER_NODE_NAME }}"
        echo "Namespace: {{ .NAMESPACE }}"
        echo "OS User: {{ .DEFAULT_USER }}"
        echo "Bastion: user@{{ .JUMPHOST_EXT_IP }}:{{ .JUMPHOST_NODEPORT }}"
        echo vms:
        kubectl -n {{ .NAMESPACE }} get vm
        echo "Grafana URL https://grafana.{{ .NAMESPACE }}.{{ .DOMAIN }}"
        echo "Default user/password admin@deckhouse.io/{{ .PASSWORD}}"

  install:
    cmds:
    - task: infra-deploy
    - task: dhctl-bootstrap
    - task: show-connection-info

  kill-dvp-resources:
    cmds:
      - kubectl -n {{ .NAMESPACE }} delete vm --all --force --grace-period=0
      - kubectl -n {{ .NAMESPACE }} delete vd --all --force --grace-period=0

  ssh-to-master:
    cmds:
      - /usr/bin/ssh -i {{ .SSH_PRIV_KEY_FILE }} -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o 'ProxyCommand=d8 v port-forward --stdio=true master-0.{{ .NAMESPACE }} 22' {{ .DEFAULT_USER }}@master-0

  ssh-to-worker:
    cmds:
      - /usr/bin/ssh -i {{ .SSH_PRIV_KEY_FILE }} -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o 'ProxyCommand=d8 v port-forward --stdio=true worker-0.{{ .NAMESPACE }} 22' {{ .DEFAULT_USER }}@worker-0

  ssh-to-master-via-jumphost:
    vars:
      SSH_AGENT_SOCK: "{{ .SSH_DIR }}/{{ .SSH_FILE_NAME }}.sock"
      JUMPHOST_EXT_IP:
        sh: kubectl -n {{ .NAMESPACE }} exec -it deployment/jump-host -- dig @resolver4.opendns.com myip.opendns.com +short
      JUMPHOST_NODEPORT:
        sh: kubectl -n {{ .NAMESPACE }} get svc jump-host -o json | jq '.spec.ports[] | select(.port==2222) | .nodePort'
      MASTER_NODE_IP:
        sh: kubectl -n {{ .NAMESPACE }} get vm master-0 -o jsonpath="{.status.ipAddress}"
    cmds:
      # kill ssh-agent
      - ps aux | grep '{{ .SSH_AGENT_SOCK }}' | grep -v grep | awk '{print $2}' | xargs -r kill -9 || true
      # remove ssh-agent sock
      - rm -rf {{ .SSH_AGENT_SOCK }} || true
      # create temp ssh-agent
      - eval $(ssh-agent -a {{ .SSH_AGENT_SOCK }})
      # add ssh key to agent
      - SSH_AUTH_SOCK={{ .SSH_AGENT_SOCK }} ssh-add {{ .SSH_PRIV_KEY_FILE }}
      # check ssh-agent
      - SSH_AUTH_SOCK={{ .SSH_AGENT_SOCK }} ssh-add -l
      # connect to master via jumphost
      - |
          SSH_AUTH_SOCK={{ .SSH_AGENT_SOCK }} \
            /usr/bin/ssh \
              -A -vv \
              -J user@{{ .JUMPHOST_EXT_IP }}:{{ .JUMPHOST_NODEPORT }} \
              -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              {{ .DEFAULT_USER }}@{{ .MASTER_NODE_IP}}

  ssh-to-master-via-ws:
    vars:
      SSH_AGENT_SOCK: "{{ .SSH_DIR }}/{{ .SSH_FILE_NAME }}.sock"
      DOMAIN:
        sh: yq eval '.discovered.domain' {{ .DISCOVERED_VALUES_FILE }}
      MASTER_NODE_IP:
        sh: kubectl -n {{ .NAMESPACE }} get vm master-0 -o jsonpath="{.status.ipAddress}"
    cmds:
      # kill wstunnel
      - ps aux | grep wstunnel | grep tcp://9999:127.0.0.1:2222 | awk '{print $2}' | xargs -r kill -9 || true
      # start wstunnel
      - wstunnel client -L tcp://9999:127.0.0.1:2222  wss://ws.{{ .NAMESPACE }}.{{ .DOMAIN }}:443 &
      # kill ssh-agent
      - ps aux | grep '{{ .SSH_AGENT_SOCK }}' | grep -v grep | awk '{print $2}' | xargs -r kill -9 || true
      # remove ssh-agent sock
      - rm -rf {{ .SSH_AGENT_SOCK }} || true
      # create temp ssh-agent
      - eval $(ssh-agent -a {{ .SSH_AGENT_SOCK }})
      # add ssh key to agent
      - SSH_AUTH_SOCK={{ .SSH_AGENT_SOCK }} ssh-add {{ .SSH_PRIV_KEY_FILE }}
      # check ssh-agent
      - SSH_AUTH_SOCK={{ .SSH_AGENT_SOCK }} ssh-add -l
      # # remove known_hosts entry
      - ssh-keygen -f "${HOME}/.ssh/known_hosts" -R "[127.0.0.1]:9999"
      # connect to master via jumphost
      - |
          SSH_AUTH_SOCK={{ .SSH_AGENT_SOCK }} \
            /usr/bin/ssh \
              -A \
              -J user@127.0.0.1:9999 \
              -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              {{ .DEFAULT_USER }}@{{ .MASTER_NODE_IP}}

  clean:
    cmds:
      - task: infra-undeploy
      - rm -rf "{{ .TMP_DIR }}"

  __ssh-command:
    silent: true
    internal: true
    cmds:
      - /usr/bin/ssh -t -i {{ .SSH_PRIV_KEY_FILE }} -o LogLevel=ERROR -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o 'ProxyCommand=d8 v port-forward --stdio=true master-0.{{ .NAMESPACE }} 22' {{ .DEFAULT_USER }}@master-0 {{ .CMD }}

  kubectl:
    desc: Run kubectl on master. Usage example "task kubectl -- get pods -A"
    cmds:
    - task: __ssh-command
      vars:
        CMD: sudo /opt/deckhouse/bin/kubectl {{ .CLI_ARGS }}

  k9s:
    desc: Run kubectl on master. Usage example "task kubectl -- get pods -A"
    cmds:
    - task: __ssh-command
      vars:
        CMD: TERM=xterm-256color sudo /usr/local/bin/k9s {{ .CLI_ARGS }}

  configure:storage:sds-lvg:
    desc: Copy storage manifests to master
    vars:
      script: gen-lvg.sh
      config: /tmp/sds-local-lvg.yaml
    cmds:
    - rsync -azv -e "ssh -i {{ .SSH_PRIV_KEY_FILE }} -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o 'ProxyCommand=d8 v port-forward --stdio=true master-0.{{ .NAMESPACE }} 22'" storage/sds-local-volume/{{ .script }} {{ .DEFAULT_USER }}@master-0:/tmp/
    - task: __ssh-command
      vars:
        CMD: sudo chmod +x /tmp/{{ .script }}
    - task: __ssh-command
      vars:
        CMD: sudo /tmp/{{ .script }}
    - task: __ssh-command
      vars:
        CMD: sudo /opt/deckhouse/bin/kubectl apply -f {{ .config }}

  configure:storage:local-sc:
    desc: Copy storage manifests to master
    vars:
      script: gen-sc.sh
      config: /tmp/sds-local-sc
    cmds:
    - rsync -azv -e "ssh -i {{ .SSH_PRIV_KEY_FILE }} -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o 'ProxyCommand=d8 v port-forward --stdio=true master-0.{{ .NAMESPACE }} 22'" storage/sds-local-volume/{{ .script }} {{ .DEFAULT_USER }}@master-0:/tmp/
    - task: __ssh-command
      vars:
        CMD: sudo chmod +x /tmp/{{ .script }}
    - task: __ssh-command
      vars:
        CMD: sudo /tmp/{{ .script }}
    - task: __ssh-command
      vars:
        CMD: sudo /opt/deckhouse/bin/kubectl apply -f {{ .config }}.yaml
    - task: __ssh-command
      vars:
        CMD: sudo /opt/deckhouse/bin/kubectl apply -f {{ .config }}-multi.yaml
