# https://taskfile.dev

version: "3"

vars:
  NAMESPACE:
    sh: yq eval '.namespace' values.yaml
  DECKHOUSE_CHANNEL:
    sh: yq eval '.deckhouse.channel' values.yaml
  DEFAULT_USER:
    sh: yq eval '.image.defaultUser' values.yaml
  TMP_DIR: ./tmp
  SSH_DIR: "{{ .TMP_DIR }}/ssh"
  SSH_FILE_NAME: cloud
  SSH_PUB_KEY_FILE: "{{ .SSH_DIR }}/{{ .SSH_FILE_NAME }}.pub"
  SSH_PRIV_KEY_FILE: "{{ .SSH_DIR }}/{{ .SSH_FILE_NAME }}"
  DISCOVERED_VALUES_FILE: tmp/discovered-values.yaml
  PASSWORD_FILE: "{{ .TMP_DIR }}/password.txt"
  PASSWORD_HASH_FILE: "{{ .TMP_DIR }}/password-hash.txt"
  VM_USER_PASSWD: "Y2xvdWQK"
tasks:
  create-tmp-dir:
    desc: Preflight / Create tmp dir
    cmds:
      - mkdir -p "{{ .TMP_DIR }}"
      - mkdir -p "{{ .SSH_DIR }}"
    status:
      - test -d "{{ .TMP_DIR }}"
      - test -d "{{ .SSH_DIR }}"

  ssh-gen:
    desc: Preflight / Generate ssh keypair for jump-host
    deps:
      - create-tmp-dir
    cmds:
      - ssh-keygen -t ed25519 -b 1024 -f {{ .SSH_PRIV_KEY_FILE }} -N "" -C "cloud"
      - chmod 0600 "{{ .SSH_PUB_KEY_FILE }}"
      - chmod 0400 "{{ .SSH_PRIV_KEY_FILE }}"
    status:
      - test -f "{{ .SSH_PRIV_KEY_FILE }}"

  password-gen:
    desc: Preflight / Generate password
    deps:
      - ssh-gen
    cmds:
      - date +%s | sha256sum | base64 | head -c 10 > {{ .PASSWORD_FILE }}
      - |
        echo $(cat {{ .TMP_DIR }}/password.txt) | htpasswd -BinC 10 "" | cut -d: -f2 | base64 -w0 > {{ .PASSWORD_HASH_FILE }}
    status:
      - test -f "{{ .PASSWORD_FILE }}"
      - test -f "{{ .PASSWORD_HASH_FILE }}"

  generate-helm-values:
    desc: Generate helm values {{ .DISCOVERED_VALUES_FILE }}
    deps:
      - password-gen
    cmds:
      - touch {{ .DISCOVERED_VALUES_FILE }}
      - |
        export SSH_PUB_KEY="$(cat {{ .SSH_PUB_KEY_FILE }})"
        yq eval --inplace '.discovered.publicSSHKey = env(SSH_PUB_KEY)' {{ .DISCOVERED_VALUES_FILE }}
      - |
        export SSH_PRIV_KEY_B64="$(cat {{ .SSH_PRIV_KEY_FILE }} | base64 -w 0)"
        yq eval --inplace '.discovered.privateSSHKeyBase64 = env(SSH_PRIV_KEY_B64)' {{ .DISCOVERED_VALUES_FILE }}
      - |
        export DOMAIN=$(kubectl get mc global -o json | jq '.spec.settings.modules.publicDomainTemplate | split(".")[1:] | join(".")' -rc)
        yq eval --inplace '.discovered.domain = env(DOMAIN)' {{ .DISCOVERED_VALUES_FILE }}
      - |
        export CLUSTER_DOMAIN=$(kubectl -n d8-system exec svc/deckhouse-leader -- deckhouse-controller global values -o json | jq -rc .clusterConfiguration.clusterDomain)
        yq eval --inplace '.discovered.clusterDomain = env(CLUSTER_DOMAIN)' {{ .DISCOVERED_VALUES_FILE }}
      - |
        export PASSWORD_HASH="$(cat {{ .PASSWORD_HASH_FILE }})"
        yq eval --inplace '.discovered.passwordHash = env(PASSWORD_HASH)' {{ .DISCOVERED_VALUES_FILE }}
      - |
        export USER_PASSWD="$(echo "{{ .VM_USER_PASSWD }}" | base64 -d | htpasswd -BinC 10 "" | cut -d: -f2)"
        yq eval --inplace '.discovered.userPasswd = env(USER_PASSWD)' {{ .DISCOVERED_VALUES_FILE }}

  render-vm-ips:
    desc: Get VM IPs
    cmds:
      - |
        if kubectl -n {{ .NAMESPACE }} get vm -o name 2>/dev/null | grep -q .; then
          export VM_IPS=$(kubectl -n {{ .NAMESPACE }} get vm -o json | jq -r '[.items[] | select(.status.ipAddress != null) | .metadata.name + ": " + .status.ipAddress] | join("\n")')
          yq eval --inplace '.discovered.vmIPs = env(VM_IPS)' {{ .DISCOVERED_VALUES_FILE }}
        else
          yq eval --inplace '.discovered.vmIPs = {}' {{ .DISCOVERED_VALUES_FILE }}
        fi

  render-infra:
    desc: Preparation / Generate infra manifests
    deps:
      - generate-helm-values
    cmds:
      - helm template static-dvp-over-dvp-infra ./charts/infra -f values.yaml -f {{ .DISCOVERED_VALUES_FILE }} >> {{ .TMP_DIR }}/infra.yaml

  infra-deploy:
    deps:
      - render-infra
    desc: Deploy infra (Namespace/RBAC/Jumphost)
    vars:
      start_time:
        sh: date +%s
    cmds:
      - kubectl apply -f {{ .TMP_DIR }}/infra.yaml
      - kubectl -n {{ .NAMESPACE }} get all
      - kubectl -n {{ .NAMESPACE }} wait --for=condition=Ready pod -l app=jump-host --timeout=300s
      - kubectl -n {{ .NAMESPACE }} get vi -o name | xargs kubectl -n {{ .NAMESPACE }} wait --for='jsonpath={.status.phase}=Ready' --timeout=600s
      - kubectl -n {{ .NAMESPACE }} get vd -o name | xargs kubectl -n {{ .NAMESPACE }} wait --for='jsonpath={.status.phase}=Ready' --timeout=600s
      - kubectl -n {{ .NAMESPACE }} get vm -o name | xargs kubectl -n {{ .NAMESPACE }} wait --for='jsonpath={.status.phase}=Running' --timeout=600s
      - kubectl -n {{ .NAMESPACE }} get vm -o name | xargs kubectl -n {{ .NAMESPACE }} wait --for='jsonpath={.status.conditions[?(@.type=="AgentReady")].status}=True' --timeout=300s
      - |
        export end_time=$(date +%s)
        difference=$((end_time - {{.start_time}}))
        date -ud "@$difference" +'%H:%M:%S'
      - task: render-vm-ips

  infra-undeploy:
    desc: Destroy infra
    aliases:
      - uninstall
    cmds:
      - kubectl delete -f {{ .TMP_DIR }}/infra.yaml --timeout 300s || true
      - kubectl wait --for=delete namespace/{{ .NAMESPACE }} --timeout 300s || true

  render-cluster-config-proxy:
    desc: Add proxy if enabled
    cmds:
      - |
        if yq eval '.deckhouse.proxyEnabled' values.yaml; then
          yq eval --inplace '.proxy.httpProxy = env(HTTP_PROXY) | .proxy.httpsProxy = env(HTTPS_PROXY)' values.yaml
        fi

  render-cluster-config:
    desc: Preparation / Generate cluster config (infra required)
    deps:
      - ssh-gen
      - generate-helm-values
      - render-cluster-config-proxy
    cmds:
      - helm template dvp-over-static-dvp-cluster-config ./charts/cluster-config -f values.yaml -f {{ .DISCOVERED_VALUES_FILE }} > {{ .TMP_DIR }}/config.yaml

  infra-undeploy-jumphost:
    desc: Undeploy Jumphost
    cmds:
      - |
        kubectl -n {{ .NAMESPACE }} get all -l infra=jump-host || true
        kubectl -n {{ .NAMESPACE }} delete all -l infra=jump-host || true

  dhctl-bootstrap:
    desc: Bootstrap DKP over DVP
    deps:
      - render-cluster-config
    vars:
      DeckhouseInstallImage: "registry.deckhouse.io/deckhouse/ee/install"
      prefix:
        sh: yq eval '.storageType' values.yaml
      start_time:
        sh: date +%s
      JUMPHOST_EXT_IP:
        sh: kubectl -n {{ .NAMESPACE }} exec deployment/jump-host -- dig @resolver4.opendns.com myip.opendns.com +short
      JUMPHOST_NODEPORT:
        sh: kubectl -n {{ .NAMESPACE }} get svc jump-host -o json | jq '.spec.ports[] | select(.port==2222) | .nodePort'
      MASTER_NODE_IP:
        sh: kubectl -n {{ .NAMESPACE }} get vm {{.prefix}}-master-0 -o jsonpath="{.status.ipAddress}"
    cmds:
      - |
        docker run --pull=always \
        -v "{{ .TMP_DIR }}/config.yaml:/config.yaml" \
        -v "{{ .SSH_DIR }}:/tmp/.ssh/" \
        -v "{{ .TMP_DIR }}/dhctl:/tmp/dhctl/" \
        {{ .DeckhouseInstallImage }}:{{ .DECKHOUSE_CHANNEL }} \
            dhctl bootstrap \
            --config=/config.yaml \
            --ssh-agent-private-keys=/tmp/.ssh/{{ .SSH_FILE_NAME }} \
            --ssh-host={{ .MASTER_NODE_IP }} \
            --ssh-user={{ .DEFAULT_USER }} \
              --ssh-bastion-port={{ .JUMPHOST_NODEPORT }} \
              --ssh-bastion-host={{ .JUMPHOST_EXT_IP }} \
              --ssh-bastion-user=user \
            {{.CLI_ARGS}}
      - |
        export end_time=$(date +%s)
        difference=$((end_time - {{.start_time}}))
        date -ud "@$difference" +'%H:%M:%S'
      - task: infra-undeploy-jumphost

  show-connection-info:
    desc: Show connection info
    vars:
      DOMAIN:
        sh: yq eval '.discovered.domain' {{ .DISCOVERED_VALUES_FILE }}
      PASSWORD:
        sh: cat {{ .PASSWORD_FILE }}
      MASTER_NODE_NAME:
        sh: kubectl get node -l node.deckhouse.io/group=master -o jsonpath="{.items[0].metadata.name}"

    silent: true
    cmds:
      - echo "Connect to master task ssh-to-master"
      - |
        echo "Host cluster master node: {{ .MASTER_NODE_NAME }}"
        echo "Namespace: {{ .NAMESPACE }}"
        echo "OS User: {{ .DEFAULT_USER }}"
        echo vms:
        kubectl -n {{ .NAMESPACE }} get vm
        echo "Grafana URL https://grafana.{{ .NAMESPACE }}.{{ .DOMAIN }}"
        echo "Default user/password admin@deckhouse.io/[see password in password.txt in artifact]"
