---
apiVersion: deckhouse.io/v1alpha1
kind: NodeGroupConfiguration
metadata:
  name: qemu-guest-agent-install-ubuntu.sh
spec:
  weight: 98
  nodeGroups: ["*"]
  bundles: ["ubuntu-lts", "debian"]
  content: |
    bb-apt-install qemu-guest-agent
    systemctl enable --now qemu-guest-agent
---
apiVersion: deckhouse.io/v1alpha1
kind: NodeGroupConfiguration
metadata:
  name: astra-d8-dm-modules.conf
spec:
  weight: 98
  nodeGroups: ["*"]
  bundles: ["astra", "ubuntu-lts", "debian"]
  content: |
    bb-sync-file /etc/modules-load.d/d8-dm-modules.conf - << "EOF"
    dm_snapshot
    dm_thin_pool
    dm_cache
    EOF

    systemctl restart systemd-modules-load.service
---
apiVersion: deckhouse.io/v1alpha1
kind: NodeGroupConfiguration
metadata:
  name: install-tools.sh
spec:
  weight: 98
  nodeGroups: ["*"]
  bundles: ["*"]
  content: |
    bb-sync-file /etc/profile.d/01-kubectl-aliases.sh - << "EOF"
      source <(/opt/deckhouse/bin/kubectl completion bash)
      alias k=kubectl
      complete -o default -F __start_kubectl k
    EOF

    if [ ! -f /usr/local/bin/k9s ]; then
      K9S_URL=$(curl -s https://api.github.com/repos/derailed/k9s/releases/latest | jq '.assets[] | select(.name=="k9s_Linux_amd64.tar.gz") | .browser_download_url' -r)
      curl -L "${K9S_URL}" | tar -xz -C  /usr/local/bin/ "k9s"
    fi

    if [ ! -f /usr/local/bin/stern ]; then
      STERN_URL=$(curl -s https://api.github.com/repos/stern/stern/releases/latest | jq '.assets[].browser_download_url | select(. | test("linux_amd64"))' -r)
      curl -L "${STERN_URL}" | tar -xz -C  /usr/local/bin/ "stern"
    fi
