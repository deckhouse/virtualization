project: virtualization
configVersion: 1

# base_images
{{- $_ := set . "Images" (.Files.Get "image_versions.yml" | fromYaml) }}
  {{- range $k, $v := .Images }}
    {{ $baseImagePath := (printf "%s%s" $.Images.REGISTRY_PATH (trimSuffix "/" $v)) }}
    {{- if ne $k "REGISTRY_PATH" }}
      {{- $_ := set $.Images $k $baseImagePath }}
    {{- end }}
  {{- end }}

# modules_images
{{- define "module_image_template" }}
---
  {{- if eq .ImageInstructionType "Dockerfile" }}
image: images/{{ .ComponentName }}/{{ .ImageName }}
context: images/{{ .ComponentName }}/{{ .ImageName }}
dockerfile: Dockerfile
args:
  BASE_ALPINE: {{ .Images.BASE_ALPINE }}
  BASE_RUST: {{ .Images.BASE_RUST }}
  BASE_GOLANG_ALPINE: {{ .Images.BASE_GOLANG_ALPINE }}
  BASE_GOLANG_16_ALPINE: {{ .Images.BASE_GOLANG_16_ALPINE }}
  BASE_GOLANG_17_ALPINE: {{ .Images.BASE_GOLANG_17_ALPINE }}
  BASE_GOLANG_BUSTER: {{ .Images.BASE_GOLANG_BUSTER }}
  BASE_GOLANG_16_BUSTER: {{ .Images.BASE_GOLANG_16_BUSTER }}
  BASE_GOLANG_17_BUSTER: {{ .Images.BASE_GOLANG_17_BUSTER }}
  BASE_GOLANG_18_BULLSEYE: {{ .Images.BASE_GOLANG_18_BULLSEYE }}
  BASE_GOLANG_18_ALPINE: {{ .Images.BASE_GOLANG_18_ALPINE }}
  BASE_GOLANG_19_ALPINE: {{ .Images.BASE_GOLANG_19_ALPINE }}
  BASE_GOLANG_19_BULLSEYE: {{ .Images.BASE_GOLANG_19_BULLSEYE }}
  BASE_GOLANG_19_BUSTER: {{ .Images.BASE_GOLANG_19_BUSTER }}
  BASE_GOLANG_20_ALPINE: {{ .Images.BASE_GOLANG_20_ALPINE }}
  BASE_GOLANG_20_BULLSEYE: {{ .Images.BASE_GOLANG_20_BULLSEYE }}
  BASE_GOLANG_20_BUSTER: {{ .Images.BASE_GOLANG_20_BUSTER }}
  BASE_NGINX_ALPINE:  {{ .Images.BASE_NGINX_ALPINE }}
  BASE_NODE_16_ALPINE: {{ .Images.BASE_NODE_16_ALPINE }}
  BASE_PYTHON_ALPINE:  {{ .Images.BASE_PYTHON_ALPINE }}
  BASE_SHELL_OPERATOR: {{ .Images.BASE_SHELL_OPERATOR }}
  BASE_UBUNTU_BIONIC: {{ .Images.BASE_UBUNTU_BIONIC }}
  BASE_UBUNTU: {{ .Images.BASE_UBUNTU }}
  BASE_JEKYLL: {{ .Images.BASE_JEKYLL }}
  BASE_SCRATCH: {{ .Images.BASE_SCRATCH }}
  {{- else }}
{{ tpl .ImageBuildData . }}
  {{- end }}
{{- end }}

{{- $Root := . }}

{{- $ImagesIDList := list }}
{{ $ImagesBuildFiles := .Files.Glob "images/*/*/{Dockerfile,werf.inc.yaml}" }}
{{- range $path, $content := $ImagesBuildFiles  }}
  {{- $ctx := dict }}
  {{- if regexMatch "/werf.inc.yaml$" $path }}
    {{- $_ := set $ctx "ImageInstructionType" "Stapel" }}
  {{- else }}
    {{- $_ := set $ctx "ImageInstructionType" "Dockerfile" }}
  {{- end }}
  {{- $ImageData := $path | split "/" }}
  {{- $_ := set $ctx "ComponentName" $ImageData._1 }}
  {{- $_ := set $ctx "ImageName" $ImageData._2 }}
  {{- $_ := set $ctx "ImageBuildData" $content }}
  {{- $_ := set $ctx "Images" $Root.Images }}
  {{- include "module_image_template" $ctx }}
  {{- range $ImageYamlMainfest := regexSplit "\n?---[ \t]*\n" (include "module_image_template" $ctx) -1 }}
    {{- $ImageManifest := $ImageYamlMainfest | fromYaml }}
    {{- if $ImageManifest.image }}
      {{- $ImagesIDList = append $ImagesIDList $ImageManifest.image }}
    {{- end }}
  {{- end }}
{{- end }}
---
image: images-digests
from: alpine:3.17
dependencies:
  {{- range $ImageID := $ImagesIDList }}
  {{- $ImageNameCamel  := $ImageID | splitList "/" | last  | camelcase | untitle }}
- image: {{ $ImageID }}
  before: setup
  imports:
    - type: ImageDigest
      targetEnv: MODULE_IMAGE_DIGEST_{{ $ImageNameCamel }}
  {{- end }}
shell:
  beforeInstall:
    - apk add --no-cache jq
  setup:
    - |
      env | grep MODULE_IMAGE_DIGEST | jq -Rn '
        reduce inputs as $i (
          {};
          . * (
            $i | ltrimstr("MODULE_IMAGE_DIGEST_") | sub("=";"_") |
            split("_") as [$imageName, $digest] |
            {($imageName): $digest}
          )
        )
      ' > /images_digests.json
---
image: python-dependencies
from: alpine:3.17
git:
  - add: /
    to: /
    includePaths:
      - lib/python
shell:
  beforeInstall:
    - apk add --no-cache python3 py3-pip
  setup:
    - pip3 install -r /lib/python/requirements.txt -t /lib/python/dist
---
image: bundle
from: spotify/scratch
import:
  - image: images-digests
    add: /images_digests.json
    to: /images_digests.json
    after: setup
  - image: python-dependencies
    add: /lib/python/dist
    to: /lib/python/dist
    after: setup
git:
  - add: /
    to: /
    includePaths:
      - charts
      - crds
      - hooks
      - openapi
      - templates
      - Chart.yaml
      - .helmignore
---
artifact: release-channel-version-artifact
from: alpine:3.17
git:
  - add: /
    to: /
    includePaths:
      - release.yaml
shell:
  beforeInstall:
    - apk add --no-cache curl
    - curl -sfL https://github.com/mikefarah/yq/releases/download/2.4.1/yq_linux_amd64 --output /usr/local/bin/yq
    - chmod +x /usr/local/bin/yq
  install:
    - |
      version="{{ env "CI_COMMIT_REF_NAME" }}"
      yq w /release.yaml version $version | yq r - -j > version.json
---
image: release-channel-version
from: spotify/scratch
import:
  - artifact: release-channel-version-artifact
    add: /
    to: /
    after: install
    includePaths:
      - version.json
