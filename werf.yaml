project: virtualization
configVersion: 1
build:
  imageSpec:
    author: "Deckhouse <contact@deckhouse.io>"
    clearHistory: true
    config:
      keepEssentialWerfLabels: true
      removeLabels:
        - /.*/
---
# Base Images
{{- include "parse_base_images_map" . }}
---

# Source repo settings
{{- $_ := set . "SOURCE_REPO" (env "SOURCE_REPO" "https://github.com") }}

{{- $_ := set . "SOURCE_REPO_GIT" (env "SOURCE_REPO_GIT" "https://github.com") }}

# Define packages proxy settings
{{- $_ := set . "DistroPackagesProxy" (env "DISTRO_PACKAGES_PROXY" "") }}

# svace analyze toggler
{{- $_ := set . "SVACE_ENABLED" (env "SVACE_ENABLED" "false") }}
{{- $_ := set . "SVACE_ANALYZE_HOST" (env "SVACE_ANALYZE_HOST" "example.host") }}
{{- $_ := set . "SVACE_ANALYZE_SSH_USER" (env "SVACE_ANALYZE_SSH_USER" "user") }}

{{- $_ := set $ "ImagesIDList" list }}

{{- range $path, $content := .Files.Glob ".werf/*.yaml" }}
  {{- tpl $content $ }}
{{- end }}

---
image: images-digests
fromImage: builder/alpine
dependencies:
  {{- range $ImageID := $.ImagesIDList }}
  {{- $ImageNameCamel  := $ImageID | splitList "/" | last  | camelcase | untitle }}
- image: {{ $ImageID }}
  before: setup
  imports:
    - type: ImageDigest
      targetEnv: MODULE_IMAGE_DIGEST_{{ $ImageNameCamel }}
  {{- end }}
shell:
  beforeInstall:
    - apk add --no-cache jq
  setup:
    - |
      env | grep MODULE_IMAGE_DIGEST | jq -Rn '
        reduce inputs as $i (
          {};
          . * (
            $i | ltrimstr("MODULE_IMAGE_DIGEST_") | sub("=";"_") |
            split("_") as [$imageName, $digest] |
            {($imageName): $digest}
          )
        )
      ' > /images_digests.json
      cat images_digests.json
---
image: python-dependencies
fromImage: builder/alt
git:
  - add: /lib/python/requirements.txt
    to: /requirements.txt
    stageDependencies:
      setup:
        - '*'
shell:
  beforeInstall:
    - apt-get update
    - apt-get install -y python3 python3-module-pip-run
  setup:
    - pip3 install -r /requirements.txt -t /dist
---
image: bundle
fromImage: builder/scratch
fromCacheVersion: "2024-11-07.1"
import:
  - image: images-digests
    add: /images_digests.json
    to: /images_digests.json
    after: setup
  - image: python-dependencies
    add: /dist
    to: /lib/python/dist
    after: setup
  - image: go-hooks-artifact
    add: /go-hooks
    to: /hooks/go
    after: setup
git:
  - add: /
    to: /
    includePaths:
      - charts
      - crds
      - component_versions
      - docs
      - hooks
      - openapi
      - monitoring
      - templates
      - Chart.yaml
      - module.yaml
      - .helmignore
    excludePaths:
      - component_versions/README.md
      - hooks/lib/tests
      - hooks/test*
      - docs/images/*.drawio
      - docs/images/*.sh
    {{- if eq .MODULE_EDITION "CE" }}
      - templates/virtualization-audit
    {{- end }}
---
image: release-channel-version
fromImage: builder/scratch
shell:
  install:
    - echo  '{"version":"{{ env "MODULES_MODULE_TAG" "dev" }}"}' > version.json
