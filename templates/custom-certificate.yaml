{{- /* Copy from helm-lib to work with custom certificate retrieved by the common hook in module-sdk. }} */ -}}
{{- /* Values contain non-encoded certificates, we need to base64 them for the Secret data. }} */ -}}

{{- /* Usage: {{ include "helm_lib_module_https_copy_custom_certificate" (list . "namespace" "secret_name_prefix") }} */ -}}
{{- /* Renders secret with [custom certificate](https://deckhouse.io/products/kubernetes-platform/documentation/v1/deckhouse-configure-global.html#parameters-modules-https-customcertificate) */ -}}
{{- /* in passed namespace with passed prefix */ -}}
{{- define "override_until_fixed::helm_lib_module_https_copy_custom_certificate" -}}
  {{- $context := index . 0 -}} {{- /* Template context with .Values, .Chart, etc */ -}}
  {{- $namespace := index . 1 -}} {{- /* Namespace */ -}}
  {{- $secret_name_prefix := index . 2 -}} {{- /* Secret name prefix */ -}}
  {{- $mode := include "helm_lib_module_https_mode" $context -}}
  {{- if eq $mode "CustomCertificate" -}}
    {{- $module_values := (index $context.Values (include "helm_lib_module_camelcase_name" $context)) -}}
    {{- $secret_name := include "helm_lib_module_https_secret_name" (list $context $secret_name_prefix) -}}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ $secret_name }}
  namespace: {{ $namespace }}
  {{- include "helm_lib_module_labels" (list $context) | nindent 2 }}
type: kubernetes.io/tls
data:
{{- if (hasKey $module_values.internal.customCertificateData "ca.crt") }}
  ca.crt: {{ index $module_values.internal.customCertificateData "ca.crt" | b64enc }}
{{- end }}
  tls.crt: {{ index $module_values.internal.customCertificateData "tls.crt" | b64enc }}
  tls.key: {{ index $module_values.internal.customCertificateData "tls.key" | b64enc }}
  {{- end -}}
{{- end -}}



{{- include "override_until_fixed::helm_lib_module_https_copy_custom_certificate" (list . "d8-virtualization" "ingress-tls") -}}
