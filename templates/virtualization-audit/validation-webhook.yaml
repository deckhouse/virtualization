---
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingWebhookConfiguration
metadata:
  name: virtualization-audit-admission-webhook
webhooks:
  - name: "vm.virtualization-audit.validate.d8-virtualization"
    rules:
      - apiGroups:   ["virtualization.deckhouse.io"]
        apiVersions: ["v1alpha2"]
        operations:  ["CREATE", "UPDATE", "DELETE"]
        resources:   ["virtualmachines"]
        scope:       "Namespaced"
    clientConfig:
      service:
        namespace: d8-{{ .Chart.Name }}
        name: virtualization-audit
        path: /virtualmachine
        port: 443
      caBundle: |
        {{ .Values.virtualization.internal.audit.cert.ca | b64enc }}
    admissionReviewVersions: ["v1"]
    sideEffects: None
  - name: "portforward.virtualization-audit.validate.d8-virtualization"
    rules:
      - apiGroups:   ["virtualization.deckhouse.io"]
        apiVersions: ["v1alpha2"]
        operations:  ["UPDATE"]
        resources:   ["virtualmachines/portforward"]
        scope:       "Namespaced"
    clientConfig:
      service:
        namespace: d8-{{ .Chart.Name }}
        name: virtualization-audit
        path: /portforward
        port: 443
      caBundle: |
        {{ .Values.virtualization.internal.audit.cert.ca | b64enc }}
    admissionReviewVersions: ["v1"]
    sideEffects: None
  - name: "vmop.virtualization-audit.validate.d8-virtualization"
    rules:
      - apiGroups: [ "virtualization.deckhouse.io" ]
        apiVersions: [ "v1alpha2" ]
        operations: [ "CREATE" ]
        resources: [ "virtualmachineoperations" ]
        scope: "Namespaced"
    clientConfig:
      service:
        namespace: d8-{{ .Chart.Name }}
        name: virtualization-audit
        path: /virtualmachineoperation
        port: 443
      caBundle: |
        {{ .Values.virtualization.internal.audit.cert.ca | b64enc }}
    admissionReviewVersions: [ "v1" ]
    sideEffects: None
  # - name: "vmstate.virtualization-audit.validate.d8-virtualization"
  #   objectSelector:
  #     matchExpressions:
  #       - key: "vm.kubevirt.internal.virtualization.deckhouse.io/name"
  #         operator: Exists
  #   rules:
  #     - apiGroups: [ "" ]
  #       apiVersions: [ "v1" ]
  #       operations: [ "CREATE" ]
  #       resources: [ "pods" ]
  #       scope: "Namespaced"
  #   clientConfig:
  #     service:
  #       namespace: d8-{{ .Chart.Name }}
  #       name: virtualization-audit
  #       path: /virtualmachinestate
  #       port: 443
  #     caBundle: |
  #       {{ .Values.virtualization.internal.audit.cert.ca | b64enc }}
  #   admissionReviewVersions: [ "v1" ]
  #   sideEffects: None
  # - name: "component-deletion.virtualization-audit.validate.d8-virtualization"
  #   namespaceSelector:
  #     matchLabels:
  #       kubernetes.io/metadata.name: d8-virtualization
  #   rules:
  #     - apiGroups: [ "" ]
  #       apiVersions: [ "v1" ]
  #       operations: [ "CREATE", "DELETE" ]
  #       resources: [ "pods" ]
  #       scope: "Namespaced"
  #   clientConfig:
  #     service:
  #       namespace: d8-{{ .Chart.Name }}
  #       name: virtualization-audit
  #       path: /component-deletion
  #       port: 443
  #     caBundle: |
  #       {{ .Values.virtualization.internal.audit.cert.ca | b64enc }}
  #   admissionReviewVersions: [ "v1" ]
  #   sideEffects: None
  # - name: "mc.virtualization-audit.validate.d8-virtualization"
  #   rules:
  #     - apiGroups: [ "deckhouse.io" ]
  #       apiVersions: [ "v1alpha1" ]
  #       operations: [ "CREATE", "UPDATE", "DELETE" ]
  #       resources: [ "moduleconfigs" ]
  #       scope: "Cluster"
  #   clientConfig:
  #     service:
  #       namespace: d8-{{ .Chart.Name }}
  #       name: virtualization-audit
  #       path: /moduleconfig
  #       port: 443
  #     caBundle: |
  #       {{ .Values.virtualization.internal.audit.cert.ca | b64enc }}
  #   admissionReviewVersions: [ "v1" ]
  #   sideEffects: None
