version: "3"

vars:
  PROD_REGISTRY: registry.deckhouse.io/deckhouse
  CHANNEL: '{{ .CHANNEL | default "alpha" }}'
  VERSION: "{{ .VERSION }}"

tasks:
  go:download:
    desc: "Go mod tidy"
    silent: true
    cmds:
      - go mod download

  check:releases:
    desc: "Check version on release site (https://releases.deckhouse.io/ee/modules/virtualization)"
    vars:
      COUNT: "{{ .COUNT | default 5 }}"
    deps:
      - task: go:download
    cmds:
      - go run ./main.go moduleversions --channel {{.CHANNEL}} --version {{.VERSION}} --attempt {{.COUNT}} --check-releases

  check:docs:
    desc: "Check version on documentation site (https://deckhouse.ru/modules/virtualization/stable/)"
    vars:
      COUNT: "{{ .COUNT | default 5 }}"
    deps:
      - task: go:download
    cmds:
      - go run ./main.go moduleversions --channel {{.CHANNEL}} --version {{.VERSION}} --attempt {{.COUNT}} --check-docs

  check:registry:
    desc: "Check version in the registry"
    vars:
      VERSION: "{{ .VERSION }}"
      CHANNEL: "{{ .CHANNEL }}"
      MODULE: "{{ .MODULE }}"
    cmds:
      - |
        if [[ -z "{{ .VERSION }}" ]] || [[ -z "{{ .CHANNEL }}" ]]; then
          echo "TAG and CHANNEL are required"
          exit 1
        fi

        count=5
        wait_seconds=60
        success=false
        CHECK=false

        check_editions_version() {
          local editions=("ee" "fe" "ce" "se-plus")
          local prod_registry="registry.deckhouse.io/deckhouse"
          local channel=$1
          local version=$2
          local module=$3

          for edition in ${editions[@]}; do
            if [[ -z "$module" ]]; then
              local url="${prod_registry}/${edition}:${channel}"
              local command="crane export $url - | tar -Oxf - deckhouse/version"
            else
              local url="${prod_registry}/${edition}/modules/$module/release:${channel}"
              local command="crane export $url - | tar -Oxf - version.json | jq '.version' -r"
            fi
            echo "Check version on ${edition}"
            getVersion=$(
              eval $command
            )
            if [[ "${getVersion}" != "${version}" ]]; then
              echo "Version is not valid in ${edition} and channel ${channel}"
              echo "Expected version: ${version} but got ${getVersion}"
              echo " "
              return 0
            else
              echo "Version ${version} is valid in ${edition} and channel ${channel}"
              echo " "
            fi
          done

          CHECK=true
          return 0
        }

        for i in $(seq 1 $count); do
          echo "[INFO] Attempt $i/$count..."
          check_editions_version {{ .CHANNEL }} {{ .VERSION }} {{ .MODULE }}

          if [ "$CHECK" = true ]; then
            echo "[SUCCESS] Successfully checkd version for editions."
            success=true
            break
          fi

          if [ $i -lt $count ]; then
            echo "[INFO] Retrying in ${wait_seconds} seconds..."
            sleep ${wait_seconds}
          fi
        done

        if [ "${success}" = false ]; then
          echo "[ERROR] Failed to check version for editions after $count attempts."
          exit 1
        fi

  crane:version:
    desc: "Get version from release image"
    vars:
      LICENSE: "{{ .LICENSE }}"
      REGISTRY:
        sh: |
          base64 -d <<< "{{.LICENSE}}" | jq '.auths | to_entries | .[] | .key' -r
      USERNAME:
        sh: |
          creds=$(base64 -d <<< {{ .LICENSE }} | jq '.auths | to_entries | .[] | .value.auth' -r)
          echo $creds | base64 -d | cut -d ':' -f1
      PASSWORD:
        sh: |
          creds=$(base64 -d <<< {{ .LICENSE }} | jq '.auths | to_entries | .[] | .value.auth' -r)
          echo $creds | base64 -d | cut -d ':' -f2
    cmds:
      - |
        # Check if already logged in by inspecting Docker config
        if ! jq -e --arg reg "{{.REGISTRY}}" '.auths | has($reg)' ~/.docker/config.json > /dev/null 2>&1; then
          echo "Not logged in to {{.REGISTRY}}. Authenticating via crane..."
          echo "{{.PASSWORD}}" | crane auth login {{.REGISTRY}} -u {{.USERNAME}} --password-stdin
        else
          echo "Already authenticated to {{.REGISTRY}}"
        fi
      - |
        # "se-plus" may not be accessable via lic, so skip it
        EDITIONS=("ee" "fe" "ce")
        PROD_REGISTRY={{ .PROD_REGISTRY }}

        for EDITION in ${EDITIONS[@]}; do
          echo "Check version on $EDITION"
          getVersion=$(crane export $PROD_REGISTRY/$EDITION/modules/virtualization/release:{{ .CHANNEL }} - | tar -Oxf - version.json | jq '.version' -r)

          if [[ "$getVersion" != "{{ .VERSION }}" ]]; then
            echo "Version is not valid in $EDITION and channel {{ .CHANNEL }}"
            echo "Expected version: {{ .VERSION }} but got $getVersion"
            exit 1
          fi
        done
