---
title: "Установка"
weight: 15
---

> **Внимание.** Компоненты модуля необходимо развертывать на физических серверах (bare-metal).
>
> Установка на виртуальные машины допустима только в демонстрационных целях, но при этом должна быть включена вложенная виртуализация (nested virtualization). Если модуль развернут на виртуальных машинах, техническая поддержка не предоставляется.

## Возможности масштабирования

Модуль поддерживает следующую конфигурацию:

- Максимальное количество узлов: `1000`.
- Максимальное количество виртуальных машин: `50000`.

Модуль не имеет дополнительных ограничений и совместим с любым оборудованием, которое поддерживается [операционными системами](#поддерживаемые-ос-для-узлов-платформы), на которые она может быть установлена.

## Требования к аппаратному обеспечению

1. Отдельная **машина для установки**.

   Здесь будет запускаться установщик Deckhouse. Это может быть ноутбук администратора или любой другой компьютер, который **не планируется** добавлять в кластер. Требования к этой машине:

   - ОС: Windows 10+, macOS 10.15+, Linux (Ubuntu 18.04+, Fedora 35+);
   - Установленный Docker Engine или Docker Desktop (инструкции [для Ubuntu](https://docs.docker.com/engine/install/ubuntu/), [macOS](https://docs.docker.com/desktop/mac/install/), [Windows](https://docs.docker.com/desktop/windows/install/));
   - HTTPS-доступ к хранилищу образов контейнеров `registry.deckhouse.ru`;
   - SSH-доступ по ключу к узлу, который будет **master-узлом** будущего кластера;
   - SSH-доступ по ключу к узлу, который будет **worker-узлом** будущего кластера (если кластер будет состоять не из одного master-узла).

1. **Сервер для master-узла.**

   Серверов для запуска управляющих компонентов кластера может быть несколько. Для установки достаточно одного сервера, а остальные нужно будет добавить через механизмы управления узлами.

   Требования к физическому bare metal-серверу:

   - Ресурсы:
     - Процессор:
       - Архитектура x86_64;
       - Поддержка инструкций Intel-VT (VMX) или AMD-V (SVM);
       - не менее 4 ядер;
     - ОЗУ не менее 8 ГБ;
     - Дисковое пространство:
       - не менее 60 ГБ;
       - быстрый диск (400+ IOPS);
   - ОС [из списка поддерживаемых](#поддерживаемые-ос-для-узлов-платформы):
     - ядро Linux версии `5.7` или новее;
   - **Уникальный hostname** среди всех серверов будущего кластера;
   - Сетевые доступы:
     - HTTPS-доступ к хранилищу образов контейнеров `registry.deckhouse.ru`;
     - доступ к репозиториям пакетов используемой ОС;
     - SSH-доступ от **машины для установки** (см. п.1) по ключу;
     - сетевой доступ от **машины для установки** (см. п.1) по порту `22322/TCP`;
   - Требуемое ПО:
     - пакеты `cloud-utils` и `cloud-init` должны быть установлены.
   > **Важно.** Container runtime будет установлен автоматически, поэтому пакеты `containerd` и/или `docker` не должны быть установлены.

1. **Серверы для worker-узлов.**

   Это узлы, где будут запускаться виртуальные машины, поэтому ресурсов на этих серверах должно хватать для запуска планируемого количества виртуальных машин. При использовании программно-определяемого хранилища могут потребоваться дополнительные диски.

   Требования к физическому bare metal-серверу:

   - Ресурсы:
     - Процессор:
       - Архитектура x86_64;
       - Поддержка инструкций Intel-VT (VMX) или AMD-V (SVM);
       - не менее 4 ядер.
     - ОЗУ не менее 8 ГБ.
     - Дисковое пространство:
       - не менее 60 ГБ;
       - быстрый диск (400+ IOPS);
       - дополнительные диски для программно-определяемого хранилища.
   - ОС [из списка поддерживаемых](#поддерживаемые-ос-для-узлов-платформы):
     - ядро Linux версии `5.7` или новее.
   - **Уникальный hostname** среди всех серверов будущего кластера;
   - Сетевые доступы:
     - HTTPS-доступ к хранилищу образов контейнеров `registry.deckhouse.ru`;
     - доступ к репозиториям пакетов используемой ОС;
     - SSH-доступ от **машины для установки** (см. п.1) по ключу.
   - Требуемое ПО:
     - пакеты `cloud-utils` и `cloud-init` должны быть установлены (названия могут отличаться в зависимости от выбранной ОС).
   > **Важно.** Container runtime будет установлен автоматически, поэтому пакеты `containerd` и/или `docker` не должны быть установлены.

1. **Оборудование для хранилища.**

  В зависимости от выбранного хранилища могут потребоваться дополнительные ресурсы. Подробности смотрите в разделе [Управление хранилищами](/products/virtualization-platform/documentation/admin/platform-management/storage/sds/lvm-local.html).

## Поддерживаемые ОС для узлов платформы

| Дистрибутив Linux           | Поддерживаемые версии           |
| --------------------------- | ------------------------------- |
| РЕД ОС                      | 7.3, 8.0                        |
| РОСА Сервер                 | 7.9, 12.4, 12.5.1               |
| ALT Linux                   | p10, 10.0, 10.1, 10.2, 11       |
| Astra Linux Special Edition | 1.7.2, 1.7.3, 1.7.4, 1.7.5, 1.8 |
| CentOS                      | 7, 8, 9                         |
| Debian                      | 10, 11, 12                      |
| Ubuntu                      | 18.04, 20.04, 22.04, 24.04      |

{{< alert level="warning" >}}
Обеспечение стабильной работы механизмов живой миграции требует использования идентичной версии ядра Linux на всех узлах кластера.

Это связано с тем, что различия в версиях ядра могут привести к несовместимости интерфейсов, системных вызовов и особенностей работы с ресурсами, что может нарушить процесс миграции виртуальных машин.
{{< /alert >}}

## Поддерживаемые гостевые ОС

Модуль виртуализации поддерживает операционные системы, работающие на архитектурах `x86` и `x86_64`, в качестве гостевых ОС. Для корректной работы в режиме паравиртуализации необходимо установить драйверы `VirtIO`, обеспечивающие эффективное взаимодействие между виртуальной машиной и гипервизором.

Успешный запуск операционной системы определяется следующими критериями:

  * корректная установка и загрузка ОС;
  * бесперебойная работа основных компонентов, таких как сеть и хранилище;
  * отсутствие сбоев или ошибок в процессе работы.

Для операционных систем семейства Linux рекомендуется использовать образы гостевых ОС с поддержкой `cloud-init`, что позволяет выполнять инициализацию виртуальных машин после их создания.

Для операционных систем семейства Windows платформа поддерживает инициализацию с помощью [autounattend](https://learn.microsoft.com/ru-ru/windows-hardware/manufacture/desktop/windows-setup-automation-overview) установки.

## Поддерживаемые конфигурации виртуальных машин

Максимальное число поддерживаемых ядер: `248`
Максимальный объем оперативной памяти: `1024 Гб`

## Поддерживаемые хранилища

Виртуальные машины используют ресурсы `PersistentVolume`. Для управления этими ресурсами и выделения дискового пространства в кластере должно быть установлено одно или несколько поддерживаемых хранилищ:

| Хранилище                                  | Расположение дисков        |
|--------------------------------------------|----------------------------|
| sds-local-volume                           | Локальное                  |
| sds-replicated-volume                      | Реплики на узлах кластера  |
| Ceph-кластер                               | Внешнее хранилище          |
| NFS (Network File System)                  | Внешнее хранилище          |
| TATLIN.UNIFIED (Yadro)                     | Внешнее хранилище          |

## Порядок установки

1. Разверните кластер Deckhouse Kubernetes Platform [по инструкции](https://deckhouse.ru/gs/).

2. Для хранения данных виртуальных машин (виртуальные диски и образы) необходимо включить один или несколько поддерживаемых [хранилищ](#поддерживаемые-хранилища).

3. Установите `StorageClass` по умолчанию.

   ```shell
   # Укажите имя своего объекта StorageClass.
   DEFAULT_STORAGE_CLASS=replicated-storage-class
   sudo -i d8 k patch mc global --type='json' -p='[{"op": "replace", "path": "/spec/settings/defaultClusterStorageClass", "value": "'"$DEFAULT_STORAGE_CLASS"'"}]'
   ```

4. Включите модуль [console](https://deckhouse.ru/modules/console/stable/), который позволит управлять компонентами виртуализации через графический интерфейс (данная возможность доступна только пользователям EE-редакции).

5. Включите модуль `virtualization`:

{{< alert level="warning" >}}
Внимание! Включение модуля `virtualization` предполагает рестарт kubelet/containerd и агентов cilium на всех узлах, где предполагается запуск виртуальных машин. Это необходимо для настройки связности containerd и DVCR.
{{< /alert >}}

Для включения модуля `virtualization`, необходимо создать ресурс `ModuleConfig` содержащий настройки модуля.

{{< alert level="info" >}}
Полный перечень параметров конфигурации приведен в разделе [Настройки](./configuration.html)
{{< /alert >}}

Пример конфигурации модуля:

```yaml
d8 k apply -f - <<EOF
apiVersion: deckhouse.io/v1alpha1
kind: ModuleConfig
metadata:
  name: virtualization
spec:
  enabled: true # Включить модуль.
  settings:
    dvcr:
      storage:
        persistentVolumeClaim:
          size: 50G
          storageClassName: sds-replicated-thin-r1
        type: PersistentVolumeClaim
    virtualMachineCIDRs:
      - 10.66.10.0/24
  version: 1
EOF
```

Блок `.spec.settings.dvcr` описывает настройки для репозитория для хранения образов виртуальных машин, в нём указывается размер хранилища предоставляемого для хранения образов `.spec.settings.dvcr.storage.persistentVolumeClaim.size` и класс хранилища `.spec.settings.dvcr.storage.persistentVolumeClaim.storageClassName`.

В блоке `.spec.settings.virtualMachineCIDRs` задается список подсетей. Адреса виртуальных машин будут выделяться автоматически или по по запросу из заданных диапазонов подсетей по порядку.

{{< alert level="warning" >}}
Подсети блока `.spec.settings.virtualMachineCIDRs` не должны пересекаться с подсетями узлов, подсетью сервисов и подов.

Удалять подсети, в случае если адреса из них уже выданы виртуальным машинам - запрещено!
{{< /alert >}}

Отследить готовность модуля можно с использованием следующей команды:

```bash
d8 k get modules virtualization
```

Пример вывода:

```txt
NAME             WEIGHT   SOURCE      PHASE   ENABLED   READY
virtualization   900      deckhouse   Ready   True      True
```

Фаза модуля должен быть `Ready`.

## Обновление модуля

Модуль Virtualization использует пять каналов обновлений, предназначенных для использования в разных окружениях, к которым с точки зрения надежности применяются разные требования:

| Канал обновлений | Описание                                                                                                                                                                                                                                                                                          |
| ---------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Alpha            | Наименее стабильный канал обновлений с наиболее частым появлением новых версий. Ориентирован на кластеры разработки с небольшим количеством разработчиков.                                                                                                                                        |
| Beta             | Ориентирован на кластеры разработки, как и канал обновлений Alpha. Получает версии, предварительно опробованные на канале обновлений Alpha.                                                                                                                                                       |
| Early Access     | Рекомендуемый канал обновлений, если вы не уверены в выборе. Подойдет для кластеров, в которых идет активная работа (запускаются, дорабатываются новые приложения и т. п.). Обновления функционала до этого канала обновлений доходят не ранее чем через одну неделю после их появления в релизе. |
| Stable           | Стабильный канал обновлений для кластеров, в которых закончена активная работа и преимущественно осуществляется эксплуатация. Обновления функционала до этого канала обновлений доходят не ранее чем через две недели после их появления в релизе.                                                |
| Rock Solid       | Наиболее стабильный канал обновлений. Подойдет для кластеров, которым необходимо обеспечить повышенный уровень стабильности. Обновления функционала до этого канала доходят не ранее чем через месяц после их появления в релизе.                                                                 |

Компоненты модуля Virtualization могут обновляться автоматически, либо с ручным подтверждением по мере выхода обновлений в каналах обновления.

{{< alert level="warning" >}}
При обновлении модуля компоненты можно разделить на две категории:

- Компоненты управления ресурсами виртуализации (плоскость управления)
- Компоненты запуска виртуальных машин ("прошивка")

Обновление компонентов плоскости управления не влияет на работу уже запущенных виртуальных машин, но могут вызывать кратковременный разрыв установленных соединений по VNC/последовательному порту, на время рестарта компонент плоскости управления.

Обновления в прошивке виртуальных машин в процессе обновления платформы могут потребовать миграции виртуальных машин для перехода на новую версию "прошивки".
Миграция при обновлении осуществляется один раз, если миграция была неуспешна, владельцу виртуальной машины потребуется выполнить её самостоятельно, выполнив evict виртуальной машины, либо её перезагрузку.
{{< /alert >}}

Информацию по версиям, доступных на каналах обновления, можно получить на сайте https://releases.deckhouse.ru/
