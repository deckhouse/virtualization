---
title: "Модуль виртуализации"
menuTitle: "Виртуализация"
moduleStatus: experimental
---

## Описание

Этот модуль предназначен для запуска и управления виртуальными машинами и их ресурсами на платформе Deckhouse.

Он предлагает следующие возможности:

- Простой и интуитивно понятный интерфейс для декларативного создания и управления виртуальными машинами и их ресурсами.
- Возможность запуска приложений, которые по каким-то причинам нельзя или сложно запустить в контейнере.
- Возможность запуска приложений, требующих ОС отличных от Linux.
- Возможность запуска виртуальных машин и контейнеризованных приложений в одном окружении.
- Интеграцию с экосистемой Deckhouse, которая использует ее возможности для виртуальных машин.

## Требования

Для запуска модуля требуются следующие условия:

- Процессор с архитектурой x86_64 и поддержкой инструкций Intel-VT или AMD-V.
- Требования к ресурсам кластера и особенности их кронфигурации доступны для ознакомления на [этой](https://deckhouse.ru/guides/production.html) странице.
- Для установки поддерживается любая [совместимая](https://deckhouse.ru/documentation/v1/supported_versions.html#linux) ОС на базе Linux.
- Ядро Linux на узлах кластера должно быть версии 5.7 или более новой.
- Модуль [CNI Cilium](/documentation/v1/modules/021-cni-cilium/) для обеспечения сетевой связности виртуальных машин.
- Модули [SDS-DRBD](https://deckhouse.ru/modules/sds-drbd/stable/) или [CEPH-CSI](/documentation/v1/modules/031-ceph-csi/) для хранения данных виртуальных машин. Также возможно использовать другие варианты хранилищ, поддерживающие создание блочных устройств с режимом доступа `RWX` (`ReadWriteMany`).

Для создания ресурсов кластера, и подключения к виртуальным машинам используется утилита командной строки [d8](https://github.com/deckhouse/deckhouse-cli). Для пользователей EE-версии доступна возможность управления ресурсами через UI.

## Как включить модуль?

Порядок действий для включения модуля

1. Настройте кластер deckhouse.
2. Включите модуль [CNI Cilium](/documentation/v1/modules/021-cni-cilium/).
3. Установите и настроите хранилище SDS-DRBD/CEPH/etc.
4. Включите модуль virtualization.

## Архитектура

Модуль включает в себя следующие компоненты:

- Ядро модуля, основанное на проекте KubeVirt и использующее QEMU/KVM + libvirtd для запуска виртуальных машин.
- Deckhouse Virtualization Container Registry (DVCR) — репозиторий для хранения и кэширования образов виртуальных машин.
- Virtualization-controller — контроллер, реализующий API пользователя для создания и управления ресурсами виртуальных машин.
- Virtualization-API - API для взаимодействия с виртуальными машинами.

API предоставляет возможности для создания и управления следующими ресурсами:

- образы виртуальных машин и загрузочные образы;
- диски виртуальных машин;
- виртуальные машины;
- операции над виртуальными машинами.

### Образы виртуальных машин и загрузочные образы

Образы представляют собой неизменяемые ресурсы, которые позволяют создавать новые виртуальные машины на основе предварительно настроенных и сконфигурированных образов. В зависимости от типа, образы могут быть в форматах `raw`, `qcow2`, `vmdk` и других для образов дисков виртуальных машин, а также в формате `iso` для установочных образов.

Для загрузки образов можно использовать внешние источники, такие как `HTTP-сервер`, `container registry`, а также загрузить локальный файл через командную строку (`cli`).

> Образы могут быть подключены к виртуальной машине.
>
> - ISO-образы - как `cdrom-устройства` и всегда доступны только в режиме для чтения (`ReadOnly`).
> - Образы дисков виртуальных машин - как эфимерные диски, после рестарта машины все записанные на них данные будут утеряны

Образы бывают двух типов:

- кластерные `ClusterVirtualImage`, которые доступны для всех пользователей платформы;
- ограниченные по пространству имен `VirtualImage`, которые доступны только для пользователей `namespace`, в котором они созданы.

Все образы хранятся в `DVCR`.

### Диски виртуальных машин

Cоздание дисков для виртуальных машины обеспечивает ресурс `VirtualDisk`. Диски используются в виртуальной машине в качестве основного носителя для хранения данных. Диски могут быть созданы из внешних источников, ранее созданных образов (`VirtualImage` или `ClusterVirtualImage`) или могут быть созданы `пустыми`.

Одной из ключевых особенностей дисков является возможность изменения их размера без необходимости остановки виртуальной машины. Важно отметить, что поддерживается только возможность увеличения размера диска, в то время как уменьшение недоступно.

Более того, диски могут быть подключены к виртуальным машинам во время их работы, что обеспечивает гибкость в управлении хранилищем данных. Для этой задачи используется ресурс `VirtualMachineBlockDeviceAttachment`.

Для хранения дисков используется хранилище, предоставляемое платформой (`PVC`).

### Виртуальные машины

Ресурс `VirtualMachine` отвечает за создание виртуальной машины и управления её жизненным циклом. Через конфигурацию `VirtualMachine` можно определить параметры виртуальной машины, такие как количество процессоров, объем оперативной памяти, подключаемые образы и диски, а также правила размещения на узлах платформы, аналогично тому, как это делается для подов.

Политика запуска виртуальной машины определяет ее состояние. Она может быть всегда включена, выключена или управление состоянием может осуществляться вручную.

При переводе узла кластера в режим обслуживания, работающая виртуальная машина будет автоматически перемещена на другой подходящий узел с помощью механизма "живой миграции".

Виртуальная машина запускается внутри пода, что позволяет управлять виртуальными машинами как обычными ресурсами Kubernetes и использовать все возможности платформы, включая балансировщики нагрузки, сетевые политики, средства автоматизации и т. д.

![](images/vm.png)

### Операции над виртуальными машинами

Ресурс `VirtualMachineOperations` предназначен для декларативного управления изменением состоянием виртуальной машины. Ресурс позволяет выполнять следующие действия над виртуальными машинами: Запуск (Start), Остановка(Stop), Рестарт(Restart).
