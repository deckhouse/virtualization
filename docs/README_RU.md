---
title: "Модуль виртуализации"
menuTitle: "Виртуализация"
moduleStatus: preview
---

## Общее описание

Модуль позволяет декларативно создавать, запускать и управлять виртуальными машинами и их ресурсами на [платформе Deckhouse](https://deckhouse.ru).

Сценарии использования модуля:

- Запуск виртуальных машин с x86_64 совместимой ОС.
- Запуска виртуальных машин и контейнеризованных приложений в одном окружении.

## Требования

Модуль виртуализации требует для своей работы кластер Deckhouse Kubernetes Platform.

- Требования к процессору на узлах кластера, на которых планируется запускать виртуальные машины, включают архитектуру x86_64 и поддержку инструкций Intel-VT или AMD-V.
- Прочие требования к узлам кластера описаны в документе: [Подготовка к production](https://deckhouse.ru/guides/production.html)
- На узлах кластера поддерживается любая [совместимая](https://deckhouse.ru/documentation/v1/supported_versions.html#linux) ОС на базе Linux.
- Ядро Linux на узлах кластера должно быть версии 5.7 или более новой.

Для подключения к виртуальным машинам с использованием последовательного порта, VNC или протоколу ssh используется утилита командной строки [d8](https://github.com/deckhouse/deckhouse-cli). Для пользователей EE-версии доступна возможность управления ресурсами через UI.

## Порядок включения модуля

Для включения модуля требуется кластер Deckhouse Kubernetes Platform развернутый согласно [требованиям](#требования). Для разворачивания Deckhouse Kubernetes Platform необходимо следовать [инструкции](https://deckhouse.ru/gs/#другие-варианты).

1. Включить модуль [CNI Cilium](/documentation/v1/modules/021-cni-cilium/) для обеспечения сетевой связности ресурсов кластера.
2. Для хранения данных виртуальных машин необходимо включить один из следующих модулей согласно инструкции по их установке:

- [SDS-Replicated-volume](https://deckhouse.ru/modules/sds-replicated-volume/stable/)
- [CEPH-CSI](/documentation/v1/modules/031-ceph-csi/)

Также возможно использовать другие варианты хранилищ, поддерживающие создание блочных устройств с режимом доступа `RWX` (`ReadWriteMany`).

4. Включить [модуль](./CONFIGURATION_RU.md)

## Обновление модуля

Модуль виртуализации использует пятка каналов обновлений предназначенные для исопльзования в разных окружениях, к которым с точки зрения надежности прменяются разные требования:

| Канал обновлений | Описание                                                                                                                                                                                                                                                                                          |
| ---------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Alpha            | Наименее стабильный канал обновлений с наиболее частым появлением новых версий. Ориентирован на кластеры разработки с небольшим количеством разработчиков.                                                                                                                                        |
| Beta             | Ориентирован на кластеры разработки, как и канал обновлений Alpha. Получает версии, предварительно опробованные на канале обновлений Alpha.                                                                                                                                                       |
| Early Access     | Рекомендуемый канал обновлений, если вы не уверены в выборе. Подойдет для кластеров, в которых идет активная работа (запускаются, дорабатываются новые приложения и т. п.). Обновления функционала до этого канала обновлений доходят не ранее чем через одну неделю после их появления в релизе. |
| Stable           | Стабильный канал обновлений для кластеров, в которых закончена активная работа и преимущественно осуществляется эксплуатация. Обновления функционала до этого канала обновлений доходят не ранее чем через две недели после их появления в релизе.                                                |
| Rock Solid       | Наиболее стабильный канал обновлений. Подойдет для кластеров, которым необходимо обеспечить повышенный уровень стабильности. Обновления функционала до этого канала доходят не ранее чем через месяц после их появления в релизе.                                                                 |

Компоненты модуля могут обновляться автоматически, либо с ручным подтверждением по мере выхода обновлений в каналах обновления.

Информацию по версиям, доступных на каналах обновления можно получить на данном сайте https://releases.deckhouse.io/

## Архитектура

Модуль включает в себя следующие компоненты:

- Ядро модуля, основанное на проекте KubeVirt и использующее QEMU/KVM + libvirtd для запуска виртуальных машин.
- Deckhouse Virtualization Container Registry (DVCR) — репозиторий для хранения и кэширования образов виртуальных машин.
- Virtualization-API — контроллер, реализующий API пользователя для создания и управления ресурсами виртуальных машин.

API предоставляет возможности для декларативного создания, модификации и удаления следующих ресурсов:

- образы виртуальных машин и загрузочные образы;
- диски виртуальных машин;
- виртуальные машины;
- операции над виртуальными машинами.

## Описание функциональных характеристик

### Образы виртуальных машин и загрузочные образы

Образы представляют собой неизменяемые ресурсы, которые позволяют создавать новые виртуальные машины на основе предварительно настроенных и сконфигурированных образов. В зависимости от типа, образы могут быть в форматах `raw`, `qcow2`, `vmdk` и других для образов дисков виртуальных машин, а также в формате `iso` для установочных образов.

Для загрузки образов можно использовать внешние источники, такие как `HTTP-сервер`, `container registry`, а также загрузить локальный файл через командную строку (`cli`).

> Образы могут быть подключены к виртуальной машине.
>
> - ISO-образы - как `cdrom-устройства` и всегда доступны только в режиме для чтения (`ReadOnly`).
> - Образы дисков виртуальных машин - как эфимерные диски, после рестарта машины все записанные на них данные будут утеряны

Образы бывают двух типов:

- кластерные `ClusterVirtualImage`, которые доступны для всех пользователей платформы;
- ограниченные по пространству имен `VirtualImage`, которые доступны только для пользователей `namespace`, в котором они созданы.

Все образы хранятся в `DVCR`.

### Диски виртуальных машин

Cоздание дисков для виртуальных машины обеспечивает ресурс `VirtualDisk`. Диски используются в виртуальной машине в качестве основного носителя для хранения данных. Диски могут быть созданы из внешних источников, ранее созданных образов (`VirtualImage` или `ClusterVirtualImage`) или могут быть созданы `пустыми`.

Одной из ключевых особенностей дисков является возможность изменения их размера без необходимости остановки виртуальной машины. Важно отметить, что поддерживается только возможность увеличения размера диска, в то время как уменьшение недоступно.

Более того, диски могут быть подключены к виртуальным машинам во время их работы, что обеспечивает гибкость в управлении хранилищем данных. Для этой задачи используется ресурс `VirtualMachineBlockDeviceAttachment`.

Для хранения дисков используется хранилище, предоставляемое платформой (`PVC`).

### Виртуальные машины

Ресурс `VirtualMachine` отвечает за создание виртуальной машины и управления её жизненным циклом. Через конфигурацию `VirtualMachine` можно определить параметры виртуальной машины, такие как количество процессоров, объем оперативной памяти, подключаемые образы и диски, а также правила размещения на узлах платформы, аналогично тому, как это делается для подов.

Политика запуска виртуальной машины определяет ее состояние. Она может быть всегда включена, выключена или управление состоянием может осуществляться вручную.

При переводе узла кластера в режим обслуживания, работающая виртуальная машина будет автоматически перемещена на другой подходящий узел с помощью механизма "живой миграции".

Виртуальная машина запускается внутри пода, что позволяет управлять виртуальными машинами как обычными ресурсами Kubernetes и использовать все возможности платформы, включая балансировщики нагрузки, сетевые политики, средства автоматизации и т. д.

![](images/vm.png)

### Операции над виртуальными машинами

Ресурс `VirtualMachineOperations` предназначен для декларативного управления изменением состоянием виртуальной машины. Ресурс позволяет выполнять следующие действия над виртуальными машинами: Запуск (Start), Остановка(Stop), Рестарт(Restart).

## Ролевая модель

Для управления ресурсами модуля предусмотрены следующие роли пользователей:

- Пользователь (User)
- Привилегированный пользователь (PrivilegedUser)
- Редактор (Editor)
- Администратор (Admin)
- Редактор кластера (ClusterEditor)
- Администратор кластера (ClusterAdmin)

Далее таблице представлены матрица доступа для данных ролей

| Resource                             | User | PrivilegedUser | Editor | Admin | ClusterEditor | ClusterAdmin |
| ------------------------------------ | ---- | -------------- | ------ | ----- | ------------- | ------------ |
| virtualmachines                      | R    | R              | CRUD   | CRUD  | CRUD          | CRUD         |
| virtualdisks                         | R    | R              | CRUD   | CRUD  | CRUD          | CRUD         |
| virtualimages                        | R    | R              | R      | CRUD  | CRUD          | CRUD         |
| clustervirtualimages                 | R    | R              | R      | R     | CRUD          | CRUD         |
| virtualmachineblockdeviceattachments | R    | R              | CRUD   | CRUD  | CRUD          | CRUD         |
| virtualmachineoperations             | R    | CR             | CRUD   | CRUD  | CRUD          | CRUD         |
| virtualmachineipaddressclaims        | R    | R              | CRUD   | CRUD  | CRUD          | CRUD         |
| virtualmachineipaddressleases        | -    | -              | -      | R     | R             | CRUD         |
| virtualmachinecpumodels              | R    | R              | R      | R     | CRUD          | CRUD         |

Команды доступные для операций с утилитой командной строки d8

| d8 cli                        | User | PrivilegedUser | Editor | Admin | ClusterEditor | ClusterAdmin |
| ----------------------------- | ---- | -------------- | ------ | ----- | ------------- | ------------ |
| d8 v console                  | N    | Y              | Y      | Y     | Y             | Y            |
| d8 v ssh / scp / port-forward | N    | Y              | Y      | Y     | Y             | Y            |
| d8 v vnc                      | N    | Y              | Y      | Y     | Y             | Y            |

Перечень сокращений

| Сокращение | Операция | Соответствующая операция Kubernetes |
| ---------- | -------- | ----------------------------------- |
| C          | создать  | create                              |
| R          | читать   | get,list,watch                      |
| U          | изменить | patch, update                       |
| D          | удалить  | delete, deletecollection            |
