{{- if or (eq .Values.resources.default "vms") (eq .Values.resources.default "all") }}
{{- $count := (.Values.count | int) }}
{{- range until $count  }}
---
apiVersion: virtualization.deckhouse.io/v1alpha2
kind: VirtualMachine
metadata:
  name: {{ printf "%s-%05d" $.Values.resources.prefix . }}
  namespace: {{ $.Release.Namespace }}
  labels:
    vms: {{ $.Values.resources.prefix }}
spec:
  runPolicy: {{ $.Values.resources.virtualMachine.spec.template.runPolicy }}
  enableParavirtualization: true
  disruptions:
    # To ensure an equal amount of virtual machines with Manual and Automatic modes during testing,
    # we create every second machine with Automatic mode.
    {{- if eq $.Values.resources.virtualMachine.spec.template.restartApprovalMode "Dynamic" }}
    {{-   if eq (mod . 2) 0 }}
    restartApprovalMode: Automatic
    {{-   else }}
    restartApprovalMode: Manual
    {{-   end }}
    {{- else }}
    restartApprovalMode: Automatic
    {{- end }}
  osType: Generic
  bootloader: BIOS
  {{- with $.Values.resources.virtualMachine.spec.template.cpu }}
  cpu:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  {{- with $.Values.resources.virtualMachine.spec.template.memory }}
  memory:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  virtualMachineClassName: {{ $.Values.resources.virtualMachine.spec.template.virtualMachineClassName | default "host" }}
  blockDeviceRefs:
    {{- if eq $.Values.resources.virtualDisk.spec.template.type "virtualImage" }}
    - kind: VirtualImage
      name: {{ $.Values.resources.prefix }}-{{ $.Values.resources.virtualImage.spec.template.type | lower }}-{{ mod . $.Values.resources.virtualImage.spec.count }}
    {{- else }}
    - kind: VirtualDisk
      name: {{ printf "%s-%05d" $.Values.resources.prefix . }}
    {{- end }}
  provisioning:
    type: UserDataRef
    userDataRef:
      kind: Secret
      name: {{ $.Values.resources.prefix }}-cloud-init
{{- end }}
{{- end }}