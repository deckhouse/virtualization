{{- if or (eq .Values.resources.default "vds") (eq .Values.resources.default "all") }}
---
apiVersion: virtualization.deckhouse.io/v1alpha2
kind: VirtualImage
metadata:
{{- if $.Values.resources.virtualImage.annotation }}
  annotations:
    virtualization.deckhouse.io/use-volume-snapshot: ""
{{- end }}
  name: {{ $.Values.resources.prefix }}-{{ $.Values.resources.virtualImage.spec.template.type | lower }}
  namespace: {{ $.Release.Namespace }}
  labels:
    vms: {{ $.Values.resources.prefix }}
spec:
{{- if eq $.Values.resources.virtualImage.spec.template.type "persistentVolumeClaim" }}
  storage: PersistentVolumeClaim
  persistentVolumeClaim:
    storageClassName: {{ $.Values.resources.storageClassName }}
  dataSource:
    type: "HTTP"
    http:
      url: {{ $.Values.resources.virtualImage.spec.template.image.url }}
{{- else }}
  storage: ContainerRegistry
  dataSource:
    type: "HTTP"
    http:
      url: {{ $.Values.resources.virtualImage.spec.template.image.url }}
{{- end }}
{{- $count := (.Values.resources.virtualImage.spec.count | int) }}
{{- range until $count  }}
---
apiVersion: virtualization.deckhouse.io/v1alpha2
kind: VirtualImage
metadata:
  name: {{ $.Values.resources.prefix }}-{{ $.Values.resources.virtualImage.spec.template.type | lower }}-{{ . }}
  namespace: {{ $.Release.Namespace }}
  labels:
    vms: {{ $.Values.resources.prefix }}
spec:
{{- if eq $.Values.resources.virtualImage.spec.template.type "persistentVolumeClaim" }}
  storage: PersistentVolumeClaim
  persistentVolumeClaim:
    storageClassName: {{ $.Values.resources.storageClassName }}
  dataSource:
    type: "HTTP"
    http:
      url: {{ $.Values.resources.virtualImage.spec.template.image.url }}
{{- else }}
  storage: ContainerRegistry
  dataSource:
    type: "HTTP"
    http:
      url: {{ $.Values.resources.virtualImage.spec.template.image.url }}
{{- end }}
{{- end }}
{{- if ne .Values.resources.virtualDisk.spec.template.type "virtualImage" }}
{{- $count := (.Values.count | int) }}
{{- range until $count  }}
---
apiVersion: virtualization.deckhouse.io/v1alpha2
kind: VirtualDisk
metadata:
{{- if $.Values.resources.virtualDisk.annotation }}
  annotations:
    virtualization.deckhouse.io/use-volume-snapshot: ""
{{- end }}
  name: {{ printf "%s-%05d" $.Values.resources.prefix . }}
  namespace: {{ $.Release.Namespace }}
  labels:
    vms: {{ $.Values.resources.prefix }}
spec:
  persistentVolumeClaim:
    size: {{ $.Values.resources.virtualDisk.spec.template.size }}
    {{- if $.Values.resources.storageClass }}
    storageClassName: {{ $.Values.resources.storageClass }}
    {{- end }}
  dataSource:
    type: "ObjectRef"
    objectRef:
      kind: "VirtualImage"
      {{- if gt . ($.Values.start_count | int) }}
      name:  {{ $.Values.resources.prefix }}-{{ $.Values.resources.virtualImage.spec.template.type | lower }}-{{ mod . $.Values.resources.virtualImage.spec.count }}
      {{- else }}
      name:  {{ $.Values.resources.prefix }}-{{ $.Values.resources.virtualImage.spec.template.type | lower }}
      {{- end }}
{{- end }}
{{- end }}
{{- end }}
