version: "3"

silent: true

vars:
  GINKGO_VERSION: "2.20.0"
  VERSION: "v1.0.0"

tasks:
  copy:
    cmds:
      - |
        rm --force --recursive /tmp/testdata
        cp -a testdata /tmp/testdata

  ginkgo:
    cmds:
      - |
        if ! which ginkgo >/dev/null ; then
          echo "Ginkgo not found or not in the PATH. Install from github or run go install github.com/onsi/ginkgo/v2/ginkgo@v{{ .GINKGO_VERSION }}"
          exit 1
        fi
        v=($(ginkgo version 2>/dev/null))
        if [ "${v[2]}" != "{{ .GINKGO_VERSION }}" ]; then
          echo "Ginkgo version mismatch: {{ .GINKGO_VERSION }} is required, $v is installed."
          exit 2
        fi
  kubectl:
    cmds:
      - |
        if ! which kubectl >/dev/null ; then
          echo "kubectl not found or not in PATH"
          exit 1
        fi
  d8:
    cmds:
      - |
        if ! which d8 >/dev/null ; then
          echo "d8 not found or not in PATH. Install from https://github.com/deckhouse/deckhouse-cli/releases"
          exit 1
        fi
  run:ci:
    desc: "Separate task to run e2e tests in the CI environment"
    deps:
      - copy
      - ginkgo
      - kubectl
      - d8
    cmds:
      - |
        ginkgo \
          --skip-file vm_test.go \
          --skip-file vm_label_annotation_test.go \
          --skip-file ipam_test.go \
          --skip-file disks_test.go \
          -v

  run:
    desc: "Run e2e tests"
    deps:
      - copy
      - ginkgo
      - kubectl
      - d8
    cmds:
      - |
        ginkgo -v \
          {{if .FOCUS -}}
          --focus "{{ .FOCUS }}"
          {{ else -}}
          --skip-file vm_test.go \
          --skip-file vm_label_annotation_test.go \
          --skip-file ipam_test.go \
          --skip-file disks_test.go
          {{end}}
