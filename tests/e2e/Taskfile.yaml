version: "3"

silent: true

vars:
  GINKGO_VERSION: "2.20.0"
  VERSION: "v1.0.0"

tasks:
  copy:
    cmds:
      - |
        rm --force --recursive /tmp/testdata
        cp -a testdata /tmp/testdata

  ginkgo:
    cmds:
      - |
        v=($(ginkgo version 2>/dev/null))
        if [ "${v[2]}" != "{{ .GINKGO_VERSION }}" ]; then
          go install "github.com/onsi/ginkgo/v2/ginkgo@v{{ .GINKGO_VERSION }}" ;
        fi
  run:
    desc: "Run e2e tests"
    deps:
      - copy
    cmds:
      - |
        ginkgo \
          --skip-file vm_test.go \
          --skip-file vm_label_annotation_test.go \
          --skip-file ipam_test.go \
          --skip-file disks_test.go \
          -v

  run_local:
    desc: "Run locally e2e tests"
    deps:
      - copy
      - ginkgo
    cmds:
      - |
        ginkgo \
          --skip-file vm_test.go \
          --skip-file vm_label_annotation_test.go \
          --skip-file ipam_test.go \
          --skip-file disks_test.go \
          -v

  run_one:
    desc: "Run one test or group"
    deps:
      - copy
      - ginkgo
    cmds:
      - |
        {{if .FOCUS }}
          ginkgo --focus "{{ .FOCUS }}" -v
        {{else}}
          echo "Specify test to run"
          echo 'Example: FOCUS="Label and Annotation" task run_one'
        {{end}}
