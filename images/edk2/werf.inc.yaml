---
{{- $gitRepoName := $.ImageName }}
{{- $version := get $.Version $gitRepoName }}
{{- $gitRepoUrl := "tianocore/edk2.git" }}

image: {{ .ModuleNamePrefix }}{{ .ImageName }}-src-artifact
final: false
fromImage: {{ .ModuleNamePrefix }}src-artifact
git:
- add: {{ .ModulePathPrefix }}/images/{{ $.ImageName }}/build.sh
  to: /build.sh
  stageDependencies:
    install:
      - build.sh
- add: {{ .ModulePathPrefix }}/images/{{ $.ImageName }}/logo/Logo.bmp
  to: /Logo.bmp
  stageDependencies:
    install:
      - '**/*'
- add: {{ .ModulePathPrefix }}/images/{{ $.ImageName }}/json
  to: /FIRMWARE
  includePaths:
  - '*.json'
  stageDependencies:
    install:
      - '*.json'
- add: {{ .ModulePathPrefix }}/images/{{ $.ImageName }}/uefi-revocation-list
  to: /FIRMWARE
  includePaths:
  - '*.bin'
  stageDependencies:
    install:
      - '*.bin'
secrets:
- id: SOURCE_REPO
  value: {{ $.SOURCE_REPO_GIT }}
shell:
  install:
  - |
    mkdir -p ~/.ssh && echo "StrictHostKeyChecking accept-new" > ~/.ssh/config
    
    echo "Git clone Edk2 repository..."
    git clone --depth=1 $(cat /run/secrets/SOURCE_REPO)/{{ $gitRepoUrl }} --branch {{ $gitRepoName }}-{{ $version }} {{ $gitRepoName }}-{{ $version }}

    git clone $(cat /run/secrets/SOURCE_REPO)/tianocore/edk2-platforms.git

    cd /{{ $gitRepoName }}-{{ $version }}

    if ! [[ "$(cat /run/secrets/SOURCE_REPO)" =~ "github.com" ]];then
      echo "Change submodule url"
      git submodule set-url -- CryptoPkg/Library/OpensslLib/openssl $(cat /run/secrets/SOURCE_REPO)/openssl/openssl
      git submodule set-url -- UnitTestFrameworkPkg/Library/CmockaLib/cmocka $(cat /run/secrets/SOURCE_REPO)/tianocore/edk2-cmocka.git
      git submodule set-url -- MdeModulePkg/Universal/RegularExpressionDxe/oniguruma $(cat /run/secrets/SOURCE_REPO)/kkos/oniguruma.git
      git submodule set-url -- MdeModulePkg/Library/BrotliCustomDecompressLib/brotli $(cat /run/secrets/SOURCE_REPO)/google/brotli.git
      git submodule set-url -- BaseTools/Source/C/BrotliCompress/brotli $(cat /run/secrets/SOURCE_REPO)/google/brotli.git
      git submodule set-url -- RedfishPkg/Library/JsonLib/jansson $(cat /run/secrets/SOURCE_REPO)/akheron/jansson.git
      git submodule set-url -- UnitTestFrameworkPkg/Library/GoogleTestLib/googletest $(cat /run/secrets/SOURCE_REPO)/google/googletest.git
      git submodule set-url -- UnitTestFrameworkPkg/Library/SubhookLib/subhook $(cat /run/secrets/SOURCE_REPO)/tianocore/edk2-subhook.git
      git submodule set-url -- MdePkg/Library/BaseFdtLib/libfdt $(cat /run/secrets/SOURCE_REPO)/devicetree-org/pylibfdt.git
      git submodule set-url -- MdePkg/Library/MipiSysTLib/mipisyst $(cat /run/secrets/SOURCE_REPO)/MIPI-Alliance/public-mipi-sys-t.git
      git submodule set-url -- CryptoPkg/Library/MbedTlsLib/mbedtls $(cat /run/secrets/SOURCE_REPO)/Mbed-TLS/mbedtls.git
      git submodule set-url -- SecurityPkg/DeviceSecurity/SpdmLib/libspdm $(cat /run/secrets/SOURCE_REPO)/DMTF/libspdm.git
    fi

    git submodule update --init --recursive

---

image: {{ .ModuleNamePrefix }}{{ .ImageName }}
final: false
fromImage: {{ .ModuleNamePrefix }}base-alt-p11
import:
- image: {{ .ModuleNamePrefix }}{{ .ImageName }}-src-artifact
  add: /{{ $gitRepoName }}-{{ $version }}
  to: /{{ $gitRepoName }}-{{ $version }}
  before: install
- image: {{ .ModuleNamePrefix }}{{ .ImageName }}-src-artifact
  add: /edk2-platforms
  to: /edk2-platforms
  before: install
- image: {{ .ModuleNamePrefix }}{{ .ImageName }}-src-artifact
  add: /FIRMWARE
  to: /FIRMWARE
  before: install
- image: {{ .ModuleNamePrefix }}{{ .ImageName }}-src-artifact
  add: /Logo.bmp
  to: /Logo.bmp
  before: install
- image: {{ .ModuleNamePrefix }}{{ .ImageName }}-src-artifact
  add: /build.sh
  to: /build.sh
  before: install
shell:
  beforeInstall:
  {{- include "alt packages proxy" . | nindent 2 }}
  - | 
    apt-get install -y \
    gcc gcc-c++ \
    git curl \
    bash-completion \
    clang \
    ccache \
    make cmake \
    python3 python3-dev \
    python3-tools python3-module-setuptools \
    python3-module-pip \
    nasm acpica libssl-devel libdwarf-devel libuuid-devel bison flex \
    dosfstools mtools genisoimage binutils-devel \
    qemu-kvm-core \
    iasl \
    python3-modules-sqlite3 python3-module-virt-firmware libuuid-devel \
    qemu-img xorriso libssl-devel \
    bc zlib-devel perl-PathTools perl-IPC-Cmd perl-JSON

  {{- include "alt packages clean" . | nindent 2 }}

  install:
  - |
    cd /{{ $gitRepoName }}-{{ $version }}

    # Set env edk
    export EDK_TOOLS_PATH=$(pwd)/BaseTools
    export PACKAGES_PATH=$(pwd)/BaseTools:/edk2-platforms

    echo "Building BaseTools..."
    ln /usr/bin/python3 /usr/bin/python
    make -C BaseTools -j$(nproc) 2>&1 > /dev/null

  setup:
  - |
    /build.sh --repo-name {{ $gitRepoName }} --branch {{ $version }}

