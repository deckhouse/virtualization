---
{{- $gitRepoName := $.ImageName }}
{{- $version := get .Firmware $gitRepoName }}
{{- $gitRepoUrl := "tianocore/edk2.git" }}

{{- $name := print $.ImageName "-dependencies" -}}
{{- define "$name" -}}
altPackages:
- gcc gcc-c++
- git
- bash-completion
- clang
- ccache
- make cmake
- python3 python3-dev
- python3-tools python3-module-setuptools
- python3-module-pip
- nasm acpica bison flex
- dosfstools mtools genisoimage binutils-devel
- qemu-kvm-core
- iasl
- python3-modules-sqlite3 python3-module-virt-firmware
- libdwarf-devel
- bc perl-PathTools perl-IPC-Cmd perl-JSON
packages:
- zlib libisoburn libburn libisofs
- openssl
- libcurl util-linux
{{- end -}}

{{ $builderDependencies := include "$name" . | fromYaml }}

image: {{ .ModuleNamePrefix }}{{ .ImageName }}-src-artifact
final: false
fromImage: builder/src
git:
- add: {{ .ModuleDir }}/images/{{ .ImageName }}
  to: /src
  includePaths: build.sh
  stageDependencies:
    install:
      - build.sh
- add: {{ .ModuleDir }}/images/{{ .ImageName }}/logo
  to: /src
  includePaths: Logo.bmp
  stageDependencies:
    install:
      - '**/*'
- add: {{ .ModuleDir }}/images/{{ .ImageName }}/json
  to: /src/FIRMWARE
  includePaths:
  - '*.json'
  stageDependencies:
    install:
      - '*.json'
- add: {{ .ModuleDir }}/images/{{ .ImageName }}/uefi-revocation-list
  to: /src/FIRMWARE
  includePaths:
  - '*.bin'
  stageDependencies:
    install:
      - '*.bin'
secrets:
- id: SOURCE_REPO
  value: {{ $.SOURCE_REPO_GIT }}
shell:
  install:
  - |
    cd /src

    echo "Git clone Edk2 repository..."
    git clone \
      --depth=1 $(cat /run/secrets/SOURCE_REPO)/{{ $gitRepoUrl }} \
      --branch {{ $gitRepoName }}-{{ $version }} {{ $gitRepoName }}-{{ $version }}

    git clone $(cat /run/secrets/SOURCE_REPO)/tianocore/edk2-platforms.git

    cd {{ $gitRepoName }}-{{ $version }}

    if [[ "$(cat /run/secrets/SOURCE_REPO)" =~ "github.com" ]] ; then
      echo "Checkout submodules"
      git submodule update --init --recursive --depth=1
    else
      echo "Checkout submodules with URL rewrite"
      # mbed-tls rewrite is needed for submodules from ARMmbed renamed organization.
      git \
        -c url."$(cat /run/secrets/SOURCE_REPO)/mbed-tls/".insteadOf=https://github.com/ARMmbed/ \
        -c url."$(cat /run/secrets/SOURCE_REPO)/".insteadOf=https://github.com/  \
        -c url."$(cat /run/secrets/SOURCE_REPO)/".insteadOf=https://gitlab.com/  \
        submodule update --init --recursive  --depth=1
    fi

---

image: {{ .ModuleNamePrefix }}{{ .ImageName }}
final: false
fromImage: builder/alt
import:
- image: {{ .ModuleNamePrefix }}{{ .ImageName }}-src-artifact
  add: /src
  to: /
  before: install
  includePaths:
  - "{{ $gitRepoName }}-{{ $version }}"
  - edk2-platforms
  - FIRMWARE
  - Logo.bmp
  - build.sh
{{- include "importPackageImages" (list . $builderDependencies.packages "install") -}}
- image: {{ .ModuleNamePrefix }}qemu
  add: /qemu-img
  to: /qemu-img
  before: install
shell:
  beforeInstall:
  {{- include "alt packages proxy" . | nindent 2 }}
  - |
    apt-get install -y \
      {{ $builderDependencies.altPackages | join " " }}

  {{- include "alt packages clean" . | nindent 2 }}

  install:
  - |
    # Install packages
    PKGS="{{ $builderDependencies.packages | join " " }}"
    PKGS+=" qemu-img"
    for pkg in $PKGS; do
      cp -a /$pkg/. /
      rm -rf /$pkg
    done

    cd /{{ $gitRepoName }}-{{ $version }}

    # Set env edk
    export EDK_TOOLS_PATH=$(pwd)/BaseTools
    export PACKAGES_PATH=$(pwd)/BaseTools:/edk2-platforms

    echo "Building BaseTools..."
    ln /usr/bin/python3 /usr/bin/python
    make -C BaseTools -j$(nproc) 2>&1 > /dev/null

  setup:
  - |
    /build.sh --repo-name {{ $gitRepoName }} --branch {{ $version }}

