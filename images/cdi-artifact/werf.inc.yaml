---
{{- $version := "v1.60.3-v12n.1" }}
{{- $gitRepoUrl := "deckhouse/3p-containerized-data-importer" }}

image: {{ .ModuleNamePrefix }}{{ .ImageName }}-src-artifact
final: false
fromImage: builder/src
git:
  - add: {{ include "PreffixPath" . }}/images/{{ $.ImageName }}
    to: /src
    stageDependencies:
      install:
        - '**/*'
    excludePaths:
      - patches/README.md
secrets:
- id: SOURCE_REPO
  value: {{ $.SOURCE_REPO }}
shell:
  install:
  - |
    mkdir -p ~/.ssh && echo "StrictHostKeyChecking accept-new" > ~/.ssh/config
    echo "Git clone CDI repository..."
    git clone --depth 1 --branch {{ $version }} $(cat /run/secrets/SOURCE_REPO)/{{ $gitRepoUrl }} /src/containerized-data-importer

    rm -rf /src/containerized-data-importer/.git

---
image: {{ .ModuleNamePrefix }}{{ .ImageName }}
final: false
fromImage: builder/golang-bookworm-1.23
mount:
  - fromPath: ~/go-pkg-cache
    to: /go/pkg
import:
- image: {{ .ModuleNamePrefix }}{{ .ImageName }}-src-artifact
  add: /src/containerized-data-importer
  to: /containerized-data-importer
  before: install
secrets:
- id: SOURCE_REPO
  value: {{ $.SOURCE_REPO }}
- id: GOPROXY
  value: {{ .GOPROXY }}
shell:
  beforeInstall:
  {{- include "debian packages proxy" . | nindent 2 }}
  - |
    apt-get install --yes libnbd-dev
  {{- include "debian packages clean" . | nindent 2 }}

  install:
  - |
    export GOPROXY=$(cat /run/secrets/GOPROXY)
    mkdir -p ~/.ssh && echo "StrictHostKeyChecking accept-new" > ~/.ssh/config

  - |
    echo Download Go modules.
    cd /containerized-data-importer
    go mod download

    echo Update modules to mitigate CVEs...

    # CVE-2024-45337,CVE-2025-22869
    go get golang.org/x/crypto@v0.38.0
    # CVE-2025-22870, CVE-2025-22872
    go get golang.org/x/net@v0.40.0

    # CVE-2025-27144
    go get github.com/go-jose/go-jose/v3@v3.0.4
    go mod tidy
    go mod vendor
    # Apply patch for json-patch from 3p-cdi repo
    git apply --ignore-space-change --ignore-whitespace patches/replace-op-for-evanphx-json-patch-v5-lib.patch

  setup:
  - mkdir /cdi-binaries
  - cd /containerized-data-importer

  - export GOOS=linux
  - export GOARCH=amd64
  - export CGO_ENABLED=0
  - export X_FLAGS="-X kubevirt.io/containerized-data-importer/pkg/version.gitVersion=v{{ $version }}-patched"

  - echo ============== Build cdi-apiserver ===========
  - go build -ldflags="-s -w $X_FLAGS" -o /cdi-binaries/cdi-apiserver ./cmd/cdi-apiserver

  - echo ============== Build cdi-cloner ===========
  - go build -ldflags="-s -w" -o /cdi-binaries/cdi-cloner ./cmd/cdi-cloner

  - echo ============== Build cdi-controller ===========
  - go build -ldflags="-s -w" -o /cdi-binaries/cdi-controller ./cmd/cdi-controller

  - echo ============== Build cdi-uploadproxy ===========
  - go build -ldflags="-s -w" -o /cdi-binaries/cdi-uploadproxy ./cmd/cdi-uploadproxy

  - echo ============== Build cdi-importer ===========
  - CGO_ENABLED=1 go build -ldflags="-s -w" -o /cdi-binaries/cdi-importer ./cmd/cdi-importer

  - echo ============== Build cdi-image-size-detection  ===========
  - go build -ldflags="-s -w" -o /cdi-binaries/cdi-image-size-detection ./tools/cdi-image-size-detection

  - echo ============== Build cdi-source-update-poller  ===========
  - CGO_ENABLED=1 go build -ldflags="-s -w" -o /cdi-binaries/cdi-source-update-poller ./tools/cdi-source-update-poller

  - echo ============== Build cdi-operator  ===========
  - go build -ldflags="-s -w" -o /cdi-binaries/cdi-operator ./cmd/cdi-operator

  - chown -R 64535:64535 /cdi-binaries/*
  - ls -la /cdi-binaries

---
image: {{ .ModuleNamePrefix }}{{ .ImageName }}-cbuilder
final: false
fromImage: builder/golang-bookworm-1.23
git:
  - add: {{ include "PreffixPath" . }}/images/{{ $.ImageName }}
    to: /
    includePaths:
    - static_binaries
    stageDependencies:
      install:
        - '*.c'
shell:
  install:
  {{- include "debian packages proxy" . | nindent 2 }}
  - |
    apt-get install --yes musl-dev musl-tools
  {{- include "debian packages clean" . | nindent 2 }}
  - |
    cd /static_binaries
    echo "Building simple app that prints hello cdi"
    mkdir -p /bins
    musl-gcc -static -Os -o /bins/hello hello.c
    musl-gcc -static -Os -o /bins/printFile print_file_context.c
    strip /bins/hello
    strip /bins/printFile
