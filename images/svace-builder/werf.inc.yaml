---
image: {{ $.ImageName }}-download
final: false
fromImage: builder/alpine
secrets:
- id: SOURCE_REPO
  value: {{ $.SOURCE_REPO_GIT }}
shell:
  beforeInstall:
  - apk update
  - apk add wget
  - apk add git openssh-client
  install:
  - git clone --depth 1 --branch v4.0.250415 $(cat /run/secrets/SOURCE_REPO)/ispras/svace.git /opt/svace

---
image: {{ $.ImageName }}-alt
final: false
fromImage: BASE_ALT_P11
import:
- image: {{ $.ImageName }}-download
  add: /opt/svace
  to: /opt/svace
  before: install
shell:
  beforeInstall:
  {{- include "alt packages proxy" . | nindent 2 }}
  - |
    apt-get install -y \
      wget bzip2 golang git binutils make gcc \
      glibc-pthread glibc-devel glibc-devel-static

    echo "StrictHostKeyChecking accept-new" > ~/.ssh/config
  install:
  - |
    ln -s /opt/svace/bin/svace /usr/local/bin/svace

---
image: {{ $.ImageName }}-debian
final: false
fromImage: builder/golang-bookworm-1.23
import:
- image: {{ $.ImageName }}-download
  add: /opt/svace
  to: /opt/svace
  before: install
shell:
  beforeInstall:
  {{- include "debian packages proxy" . | nindent 2 }}
  - |
    apt-get install -y \
      bzip2

    mkdir -p /root/.ssh
    echo "StrictHostKeyChecking accept-new" > ~/.ssh/config
  install:
  - |
    ln -s /opt/svace/bin/svace /usr/local/bin/svace

