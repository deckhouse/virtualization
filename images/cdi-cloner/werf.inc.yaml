---
image: {{ $.ImageName }}
fromImage: distroless
import:
- image: {{ $.ImageName }}-bins
  add: /relocate
  to: /
  before: setup
- image: {{ $.ImageName }}-gobuild
  add: /cdi-binaries
  to: /usr/bin
  includePaths:
  - cloner-startup
  before: setup
- image: cdi-artifact
  add: /cdi-binaries
  to: /usr/bin
  includePaths:
  - cdi-cloner
  # - cloner_startup.sh
  before: setup
# Source https://github.com/kubevirt/containerized-data-importer/blob/v1.58.0/cmd/cdi-cloner/BUILD.bazel
imageSpec:
  config:
    entrypoint: ["/usr/bin/cloner-startup"]
    # entrypoint: ["/usr/bin/cloner_startup.sh"]
    user: 64535
---
{{- $binaries := "/usr/bin/sh /usr/bin/bash /usr/sbin/blockdev /usr/bin/mount /usr/bin/umount /usr/sbin/fsck /usr/sbin/blkid /usr/sbin/mkfs /usr/sbin/mkfs.ext4 /usr/sbin/mkfs.xfs /usr/sbin/dumpe2fs /usr/sbin/xfs_io /usr/sbin/xfs_growfs /usr/sbin/resize2fs" }}

image: {{ $.ImageName }}-bins
final: false
fromImage: base-alt-p11-binaries
shell:
  beforeInstall:
  - |
    /relocate_binaries.sh -i "{{ $binaries }}" -o /relocate
---
image: {{ $.ImageName }}-gobuild
final: false
from: {{ .Images.BASE_GOLANG_22_BOOKWORM }}
git:
  - add: /images/{{ $.ImageName }}/cloner-startup
    to: /app
    stageDependencies:
      install:
        - '**/*'
shell:
  beforeInstall:
    - |
      apt-get update
      apt-get install --yes libnbd-dev
      apt-get clean
  install:
    - |
      mkdir -p /cdi-binaries
      cd /app
      go build -ldflags="-s -w" -o /cdi-binaries/cloner-startup .