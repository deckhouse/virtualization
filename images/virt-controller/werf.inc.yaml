---
image: {{ .ModuleNamePrefix }}{{ .ImageName }}
fromImage: {{ .ModuleNamePrefix }}distroless
git:
  {{- include "image mount points" . }}
import:
- image: {{ .ModuleNamePrefix }}virt-artifact
  add: /kubevirt-binaries/
  to: /usr/bin
  includePaths:
  - virt-controller
  before: setup
- image: {{ .ModuleNamePrefix }}virt-artifact
  add: /kubevirt-config-files/
  to: /etc
  includePaths:
  - passwd
  - group
  - .version
  before: setup
# Source https://github.com/kubevirt/kubevirt/blob/v1.3.1/cmd/virt-controller/BUILD.bazel
{{- if eq $.DEBUG_COMPONENT "delve/virt-controller" }}
- image: debuger
  add: /app/dlv
  to: /app/dlv
  after: install
{{- end }}
imageSpec:
  config:
    user: 64535
  {{- if eq $.DEBUG_COMPONENT "delve/virt-controller" }}
    env:
      PATH: "/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/app/dlv"
      XDG_CONFIG_HOME: "/tmp"
    entrypoint: ["/app/dlv", "--listen=:2345", "--headless=true", "--continue", "--log=true", "--log-output=debugger,debuglineerr,gdbwire,lldbout,rpc", "--accept-multiclient", "--api-version=2", "exec", "/usr/bin/virt-controller", "--"]
  {{- else }}
    entrypoint: ["/usr/bin/virt-controller"]
  {{- end }}
