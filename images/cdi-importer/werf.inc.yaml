---
image: {{ .ModuleNamePrefix }}{{ .ImageName }}
fromImage: {{ .ModuleNamePrefix }}distroless
git:
  {{- include "image mount points" . }}
import:
- image: {{ .ModuleNamePrefix }}{{ .ImageName }}-bins
  add: /relocate
  to: /
  before: setup
# Source https://github.com/kubevirt/containerized-data-importer/blob/v1.60.3/cmd/cdi-importer/BUILD.bazel
imageSpec:
  config:
    entrypoint: ["/usr/bin/cdi-importer", "-alsologtostderr"]
    user: 64535

---
{{- define "cdi-importer-deps" -}}
libraries:
- libsqlite3
binaries:
  # nbd bins and libs
  - /usr/sbin/nbdkit
  - /usr/lib64/nbdkit/filters/*.so
  - /usr/lib64/nbdkit/plugins/*.so
  # Sqlite libs
  - /usr/lib64/libsqlite3.so.0
  # CDI binaries
  - /usr/bin/cdi-image-size-detection /usr/bin/cdi-importer /usr/bin/cdi-source-update-poller
  # QEMU bins
  - /usr/bin/qemu-img
packages:
- nbdkit libnbd
- libtasn1 libxml2
- xz
- libunistring
- libffi libgmp gnutls
- nettle libidn2
- p11-kit zlib
- glibc
- glib2 pcre2 libbsd libfuse3
- gcc ubdsrv liburing
- libaio libaudit libcap-ng numactl
- linux-pam
{{- end -}}

{{ $cdiImporterDependencies := include "cdi-importer-deps" . | fromYaml }}

image: {{ .ModuleNamePrefix }}{{ .ImageName }}-bins
final: false
fromImage: {{ .ModuleNamePrefix }}base-alt-p11-binaries
import:
- image: tools/util-linux
  add: /
  to: /relocate/usr
  after: setup
  includePaths:
  - sbin/blockdev
  - bin/mount
  - bin/umount
- image: {{ .ModuleNamePrefix }}cdi-artifact
  add: /cdi-binaries
  to: /usr/bin
  before: setup
  includePaths:
  - cdi-image-size-detection
  - cdi-importer
  - cdi-source-update-poller
- image: {{ .ModuleNamePrefix }}qemu
  add: /qemu-img
  to: /qemu-img
  before: install
{{- include "importPackageImages" (list . $cdiImporterDependencies.packages "install") -}}
shell:
  install:
  {{- include "alt packages proxy" . | nindent 2 }}
  - |
    apt-get install --yes \
      {{ $cdiImporterDependencies.libraries | join " " }}
  {{- include "alt packages clean" . | nindent 2 }}
  - |
    echo "Install packages"
    PKGS="{{ $cdiImporterDependencies.packages | join " " }}"
    PKGS+=" qemu-img"
    for pkg in $PKGS; do
      cp -a /$pkg/. /
      rm -rf /$pkg
    done
  setup:
  - |
    /relocate_binaries.sh -i "{{ $cdiImporterDependencies.binaries | join " " }}" -o /relocate
