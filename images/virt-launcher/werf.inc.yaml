---
image: {{ .ModuleNamePrefix }}{{ .ImageName }}
final: true
fromImage: {{ .ModuleNamePrefix }}distroless
import:
  - image: {{ .ModuleNamePrefix }}{{ .ImageName }}-binaries
    add: /relocate
    to: /
    after: install
  - image: tools/tini-v0.19.0
    add: /usr/bin/tini
    to: /usr/bin/tini
    after: install
imageSpec:
  config:
    user: 0

---
{{- $name := print $.ImageName "-dependencies" -}}
{{- define "$name" -}}
altLibs:
  - libxfs-devel
  - libpci-devel
  - libgvnc-devel
  - libfdt-devel
  - libuuid-devel
  - libtasn1-devel
  - libslirp-devel
  - libdrm-devel
  - libxdp-devel
  - libSDL2-devel
  - libSDL2_image-devel
  - libncursesw-devel
  - libalsa-devel
  - libpulseaudio-devel
  - pipewire-libs
  - pipewire-jack-libs-devel
  - libsoundio-devel
  - libsasl2-devel
  - libjpeg-devel
  - libpng-devel
  - libxkbcommon-devel
  - xkeyboard-config-devel
  - libgtk+3-devel
  - libvte
  - libvte-devel
  - libvte3-devel
  - libvirglrenderer-devel
  - libdbus
  - libusb-devel
  - liburing-devel
  - libbpf-devel
  - libspice-server-devel
  - ceph-devel
  - libnfs-devel
  - libseccomp-devel
  - libudev-devel
  - libmultipath-devel
  - libblkio-devel
  - libpmem-devel
  - libdaxctl-devel
  - bzlib-devel
  - libsnappy-devel
  - libcacard-devel
  - libusbredir-devel
  - libepoxy-devel
  - libgbm-devel
  - libvitastor-devel
  - libiscsi-devel
  - libaio-devel
  - libselinux-devel
  - libglusterfs11-api-devel
  - libvdeplug-devel
  - libpciaccess-devel
  - libyajl-devel
  - sanlock-devel
  - libpcap-devel
  - libnl-devel
  - libparted-devel
  - libdevmapper-devel
  - libglusterfs-devel
  - libfuse-devel
  - libreadline-devel
  - libsystemd-devel
  - systemtap-sdt-devel
  - glib2-devel
  - libgio-devel
  - libxml2-devel
  - libtirpc-devel
  - libclocale
  - libLLVMSPIRVLib-devel
  - ethtool
  - fdisk
  - glibc-gconv-modules
  - gnutls-utils
  - hwclock
  - iptables
  - passt
  - pcre
  - procps
  - policycoreutils
  - psmisc
  - msulogin
  - iproute2
binaries:
  # Gnu utils (requared for swtpm)
  - /usr/bin/certtool
  - /usr/bin/gnutls-cli
  - /usr/bin/ocsptool
  - /usr/bin/p11tool
  - /usr/bin/psktool
  # Xorriso (Creates an image of an ISO9660 filesystem)
  - /usr/bin/xorriso-dd-target /usr/bin/xorrisofs /usr/bin/xorriso
  # Swtpm
  - /usr/bin/swtpm /usr/bin/swtpm_bios /usr/bin/swtpm_cert /usr/bin/swtpm_ioctl /usr/bin/swtpm_localca /usr/bin/swtpm_setup
  # Dmidecode
  - /usr/sbin/biosdecode /usr/sbin/dmidecode
  # Numactl
  - /usr/bin/memhog /usr/bin/migratepages /usr/bin/migspeed /usr/bin/numactl /usr/bin/numastat
  # Iproute2
  - /usr/sbin/tc
packages:
- swtpm libtpms numactl dmidecode
- libisoburn libburn libattr libaudit
- gnutls acl libbsd libgcrypt libmd
- util-linux libfuse3 nettle libgsasl
- libnbd libcap-ng libcapstone libcurl
- libjson-c5 keyutils libisofs
- zlib zstd p11-kit linux-pam
- libssh libssh2
- libpixman libqpl rdma-core
{{- end -}}

{{ $builderDependencies := include "$name" . | fromYaml }}

{{- $gitRepoName := "libvirt" }}
{{- $version := get $.Firmware $gitRepoName }}

image: {{ .ModuleNamePrefix }}{{ .ImageName }}-binaries
final: false
fromImage: {{ .ModuleNamePrefix }}base-alt-p11-binaries
git:
  # Add qemu and virtqemud configs
  - add: {{ .ModuleDir }}/images/{{ .ImageName }}/configs
    to: /relocate/etc/libvirt
    stageDependencies:
      setup:
      - qemu.conf
      - virtqemud.conf
    includePaths:
    - qemu.conf
    - virtqemud.conf
  - add: {{ .ModuleDir }}/images/{{ .ImageName }}/configs
    to: /relocate/etc
    stageDependencies:
      setup:
      - nsswitch.conf
    includePaths:
    - nsswitch.conf
import:
# Libvirt and QEMU libraries and binaries
- image: {{ .ModuleNamePrefix }}libvirt
  add: /BINS
  to: /libvirt-bins
  before: install
- image: {{ .ModuleNamePrefix }}qemu
  add: /BINS
  to: /qemu-bins
  before: install

# EDK2 (uefi firmware)
- image: {{ .ModuleNamePrefix }}edk2
  add: /FIRMWARE/
  to: /relocate/usr/share/edk2/ovmf
  before: install
  includePaths:
  - '*.fd'
  - '*.bin'
  - '*.efi'
  - '*.iso'
- image: {{ .ModuleNamePrefix }}edk2
  add: /FIRMWARE/
  to: /relocate/usr/share/qemu/firmware
  before: install
  includePaths:
  - '*.json'
# Import from virt artifact
- image: {{ .ModuleNamePrefix }}virt-artifact
  add: /kubevirt-config-files/.version
  to: /.version
  after: install

- image: {{ .ModuleNamePrefix }}virt-artifact
  add: /kubevirt-binaries/
  to: /relocate/usr/bin
  before: setup
  includePaths:
  - container-disk
  - virt-freezer
  - virt-launcher
  - virt-launcher-monitor
  - virt-probe
  - virt-tail
- image: {{ .ModuleNamePrefix }}{{ .ImageName }}-gobuilder
  add: /binaries
  to: /relocate/usr/bin
  before: setup
  includePaths:
  - node-labeller
  - vlctl

{{- include "importPackageImages" (list . $builderDependencies.packages "install") -}}

# Statically builded
- image: {{ .ModuleNamePrefix }}packages/openssl
  add: /openssl
  to: /relocate
  after: setup
  includePaths:
  - usr/bin/openssl
- image: tools/util-linux
  add: /
  to: /relocate/usr
  after: setup
  includePaths:
  - sbin/hwclock

# GNU utilities
- image: tools/coreutils
  add: /
  to: /relocate
  after: setup
  includePaths:
  - usr/bin/cp
  - usr/bin/sleep
  - usr/bin/coreutils

- image: {{ .ModuleNamePrefix }}{{ .ImageName }}-cbuilder
  add: /bins
  to: /relocate/usr/bin
  before: setup
  includePaths:
  - temp_pod
shell:
  beforeInstall:
  {{- include "alt packages proxy" . | nindent 2 }}
  - |
    apt-get install -y \
      {{ $builderDependencies.altLibs | join " " }} \
      {{ $builderDependencies.altPackages | join " " }}

    {{- include "alt packages clean" . | nindent 2 }}
  install:
  - |
    echo "Install packages"
    PKGS="{{ $builderDependencies.packages | join " " }}"
    for pkg in $PKGS; do
      cp -a /$pkg/. /
      rm -rf /$pkg
    done

    echo "Create folder hierarchy in VBINS"
    mkdir -p /VBINS/{etc,root}
    mkdir -p /VBINS/var/{log/libvirt/qemu,log/swtpm/libvirt/qemu,lib/libvirt/qemu,run/libvirt/qemu}

    echo "=====Copy libvirt binaries to temp folder======"
    cp -a /libvirt-bins/. /VBINS/

    echo "=====Copy qemu binaries to temp folder======"
    cp -a /qemu-bins/. /VBINS/


    echo "find and copy additional libs"
    FILES=$(find /VBINS/usr/bin/ -type f)
    FILES+=" $(find /VBINS/usr/sbin/ -type f)"

    LIBS="/usr/lib64/libbsd.s* /usr/lib64/libnbd.s* /usr/lib64/libfuse3.s*"
    LIBS+=" /usr/lib64/libjson-c.s* /usr/lib64/libssh.s* /usr/lib64/libssh2.s*"
    LIBS+=" /usr/lib64/libtpms* /usr/lib64/libjson* /usr/lib64/libfuse*"
    LIBS+=" /usr/lib64/libxml2.s* /usr/lib64/libgcc_s* /usr/lib64/libaudit*"
    LIBS+=" /usr/lib64/libisoburn.s* /usr/lib64/libacl.s*"

    echo "Relocate additional libs for files in /VBINS"
    ./relocate_binaries.sh -i "$FILES" -o /VBINS

    echo "Relocate additional libs to /VBINS"
    ./relocate_binaries.sh -i "$LIBS" -o /VBINS

    cp -a /VBINS/. /relocate

    echo "Show libs after relocation in /relocate/usr/lib64"
    ls -la /relocate/usr/lib64
    # Cleanup
    rm -rf /{VBINS,qemu-bins,libvirt-bins}

  setup:
  - |
    echo "Copy binaries to /relocate"
    ./relocate_binaries.sh -i "{{ $builderDependencies.binaries | join " " }}" -o /relocate

    echo "Copy additional config swtpm"
    cp -a /etc/{swtpm_setup.conf,swtpm-localca.conf,swtpm-localca.options} /relocate/etc/

    echo "Copy xattr config"
    cp -a /etc/xattr.conf /relocate/etc

    # glibc-gconv-modules
    # This package contains helper modules necessary to convert data between various charsets
    cp -a /usr/lib64/gconv /relocate/usr/lib64/gconv

    echo "root:x:0:0:root:/root:/bin/bash" >> /relocate/etc/passwd
    echo "root:x:0:" >> /relocate/etc/group
    echo "root:x:::::::" >> /relocate/etc/shadow

    echo "qemu:x:107:107::/home/qemu:/bin/bash" >> /relocate/etc/passwd
    echo "qemu:x:107:" >> /relocate/etc/group
    mkdir -p /relocate/home/qemu
    chown -R 107:107 /relocate/home/qemu

  - |
    echo "Create symlinks for OVMF"
    mkdir -p /relocate/usr/share/OVMF

    cd /relocate/usr/share/edk2/ovmf
    ln -sf OVMF_CODE.fd   OVMF_CODE.cc.fd

    cd /relocate
    ln -sf ../edk2/ovmf/OVMF_CODE.cc.fd       usr/share/OVMF/OVMF_CODE.cc.fd

    ln -s ../edk2/ovmf/OVMF_CODE.secboot.fd   usr/share/OVMF
    ln -s ../edk2/ovmf/OVMF_VARS.fd           usr/share/OVMF
    ln -s ../edk2/ovmf/OVMF_VARS.secboot.fd   usr/share/OVMF
    ln -s ../edk2/ovmf/UefiShell.iso          usr/share/OVMF

    cd /

  - |
    convert_version() {
      local version="${1#v}"
      IFS='.' read -r major minor patch <<< "$version"
      printf "%d%03d\n" "$major" "$minor"
    }

    libvirt_version=$(convert_version {{ $version }})

    echo "libvirt_version: $libvirt_version"

    SYMLINC_LIST=$(cat <<EOF
    libvirt.so.0.${libvirt_version}.0        libvirt.so.0
    libvirt.so.0                             libvirt.so
    libvirt-qemu.so.0.${libvirt_version}.0   libvirt-qemu.so.0
    libvirt-qemu.so.0                        libvirt-qemu.so
    libvirt-lxc.so.0.${libvirt_version}.0    libvirt-lxc.so.0
    libvirt-lxc.so.0                         libvirt-lxc.so
    libvirt-admin.so.0.${libvirt_version}.0  libvirt-admin.so.0
    libvirt-admin.so.0                       libvirt-admin.so
    EOF
    )

    cd /relocate

    while IFS= read -r LINE; do
      echo "Create symlinc for $LINE"
      TARGET=$(echo $LINE | awk -F' ' '{print $1}')
      SYMLINK=$(echo $LINE | awk -F' ' '{print $2}')
      ln -s ../local/lib64/$TARGET usr/lib64/$SYMLINK
    done <<< "$SYMLINC_LIST"

    echo "List files in /relocate/usr/local/lib64"
    ls -la usr/local/lib64

  - |
    cd /relocate

    echo "Create symlinks for container-disk"
    mkdir -p /relocate/init/usr/bin
    ln -s usr/bin/container-disk ./init/usr/bin/container-disk

    echo "Create symlink for run -> var/run "
    ln -s var/run run

  # /etc/libvirt-init will be copied back into /etc/libvirt at runtime. This is necessary because we configure libvirt to mount /etc/libvirt and set readOnlyRootFilesystem for other directories.
  # DO NOT REMOVE. node-labeler.sh uses /etc/libvirt.
  - |
    cp -a etc/libvirt etc/libvirt-init

---
image: {{ .ModuleNamePrefix }}{{ .ImageName }}-gobuilder
final: false
fromImage: {{ eq $.SVACE_ENABLED "false" | ternary "builder/golang-bookworm-1.24" "builder/alt-go-svace" }}
git:
  - add: {{ .ModuleDir }}/images/{{ .ImageName }}/node-labeller
    to: /node-labeller
    includePaths:
      - '**/*'
    stageDependencies:
      install:
      - '**/*'
  - add: {{ .ModuleDir }}/images/{{ .ImageName }}/vlctl
    to: /src-vlctl
    includePaths:
      - '**/*'
    stageDependencies:
      install:
      - '**/*'
import:
{{- include "importPackageImages" (list . $builderDependencies.packages "install") -}}
secrets:
- id: GOPROXY
  value: {{ .GOPROXY }}
shell:
  install:
  {{- include "debian packages proxy" . | nindent 2 }}
  - |
    echo "install deps libvirt-dev"
{{- if eq $.SVACE_ENABLED "false" }}
    apt-get install -y libvirt-dev
  {{- include "debian packages clean" . | nindent 2 }}
{{- else }}
  - apt-get -qq install -y libvirt-devel
  {{- include "alt packages clean" . | nindent 2 }}
{{- end }}
  - |
    # Install packages
    PKGS="{{ $builderDependencies.packages | join " " }}"
    for pkg in $PKGS; do
      cp -a /$pkg/. /
      rm -rf /$pkg
    done
  - mkdir -p /binaries
  - export GOPROXY=$(cat /run/secrets/GOPROXY)
  - |
    echo "Build node-labeller binaries"
    cd /node-labeller
    echo '== go build -ldflags="-s -w" -o /binaries/node-labeller ./cmd/node-labeller =='
    {{- $_ := set $ "ProjectName" (list $.ImageName "node-labeller" | join "/") }}
    {{- include "image-build.build" (set $ "BuildCommand" `go build -ldflags="-s -w" -o /binaries/node-labeller ./cmd/node-labeller`) | nindent 6 }}
    echo "Done"
  - |
    cd /src-vlctl
    export GOOS=linux
    export GOARCH=amd64
    export CGO_ENABLED=0
    echo '== go build -ldflags="-s -w" -o /binaries/vlctl ./cmd/vlctl/main.go =='
    {{- $_ := set $ "ProjectName" (list $.ImageName "vlctl" | join "/") }}
    {{- include "image-build.build" (set $ "BuildCommand" `go build -ldflags="-s -w" -o /binaries/vlctl ./cmd/vlctl/main.go`) | nindent 6 }}
    echo "Done"
---
image: {{ .ModuleNamePrefix }}{{ .ImageName }}-cbuilder
final: false
fromImage: {{ eq $.SVACE_ENABLED "false" | ternary "builder/golang-bookworm-1.23" "builder/alt-go-svace" }}
git:
  - add: {{ .ModuleDir }}/images/{{ .ImageName }}/static_binaries
    to: /static_binaries
    stageDependencies:
      install:
        - '*.c'
shell:
  beforeInstall:
{{- if eq $.SVACE_ENABLED "false" }}
  {{- include "debian packages proxy" . | nindent 2 }}
  - apt-get install --yes musl-dev musl-tools
  {{- include "debian packages clean" . | nindent 2 }}
{{- else }}
  {{- include "alt packages proxy" . | nindent 2 }}
  - apt-get -qq install -y musl-devel musl-devel-static
  {{- include "alt packages clean" . | nindent 2 }}
{{- end }}
  install:
  - |
    cd /static_binaries
    echo "Building simple app that prints I'am temp pod"
    mkdir -p /bins

    {{- $_ := set $ "ProjectName" (list $.ImageName "temp_pod" | join "/") }}
    {{- include "image-build.build" (set $ "BuildCommand" `musl-gcc -static -Os -o /bins/temp_pod temp_pod.c`) | nindent 6 }}
    strip /bins/temp_pod
