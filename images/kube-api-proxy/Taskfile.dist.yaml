version: "3"

silent: true

includes:
  my:
    taskfile: Taskfile.my.yaml
    optional: true

vars:
  DevRegistry: "dev-registry.deckhouse.io/virt/dev"

tasks:
  dev:build:
    desc: "build local image with proxy and test-controller"
    cmds:
      - |
        docker build . -t dev-registry.deckhouse.io/virt/dev/diafour/kube-api-proxy:latest -f local/Dockerfile
        docker push dev-registry.deckhouse.io/virt/dev/diafour/kube-api-proxy:latest

  dev:deploy:
    desc: "build local image with proxy and test-controller"
    cmds:
      - |
        if ! kubectl get no 2>&1 >/dev/null ; then
          echo Restart cluster connection
          exit 1
        fi
      - |
        kubectl -n kproxy apply -f local/proxy.yaml

  dev:restart:
    desc: "build local image with proxy and test-controller"
    cmds:
      - |
        if ! kubectl get no 2>&1 >/dev/null ; then
          echo Restart cluster connection
          exit 1
        fi
      - |
        kubectl -n kproxy scale deployment/kube-api-proxy --replicas=0
        kubectl -n kproxy scale deployment/kube-api-proxy --replicas=1

  dev:redeploy:
    desc: "build local image with proxy and test-controller"
    cmds:
      - |
        if ! kubectl get no 2>&1 >/dev/null ; then
          echo Restart cluster connection
          exit 1
        fi
      - task: dev:build
      - task: dev:deploy
      - task: dev:restart
      - |
        sleep 3
        kubectl -n kproxy get all

  dev:curl:
    desc: "run curl in proxy deployment"
    cmds:
      - |
        kubectl -n kproxy exec -t deploy/kube-api-proxy -- curl {{.CLI_ARGS}}

  dev:kubectl:
    desc: "run kubectl in proxy deployment"
    cmds:
      - |
        kubectl -n kproxy exec -ti deploy/kube-api-proxy -- kubectl -s 127.0.0.1:23916 {{.CLI_ARGS}}
        #kubectl -n d8-virtualization exec -ti deploy/virt-operator -- kubectl -s 127.0.0.1:23915 {{.CLI_ARGS}}

  logs:proxy:
    desc: "Show proxy logs"
    cmds:
      - |
        kubectl -n kproxy logs deployments/kube-api-proxy -c proxy-only -f

  logs:controller:
    desc: "Show controller logs"
    cmds:
      - |
        kubectl -n kproxy logs deployments/kube-api-proxy -c controller -f

  virt-controller:replace:
    desc: "Run non-patched virt-controller with kube-api-proxy"
    cmds:
      - |
        echo "Scale virt-operator to 0"
        kubectl -n d8-virtualization scale deploy/virt-operator --replicas=0
      - |
        echo "Delete virt-controller"
        kubectl -n d8-virtualization delete deploy/virt-controller
      - |
        echo "Create virt-controller with proxy"
        kubectl -n d8-virtualization apply -f local/virt-controller.yaml

  virt-controller:restart:
    desc: "Restart deploy/virt-controller"
    cmds:
      - |
        echo "Scale virt-controller to 0 and back to 1"
        kubectl -n d8-virtualization scale deploy/virt-controller --replicas=0
        sleep 2
        kubectl -n d8-virtualization scale deploy/virt-controller --replicas=1

  virt-controller:restore:
    desc: "Restore virt-controller with virt-operator"
    cmds:
      - |
        echo "Delete virt-controller with proxy"
        kubectl -n d8-virtualization delete --wait=true -f local/virt-controller-proxy.yaml || true
      - |
        echo "Scale virt-operator to 1"
        kubectl -n d8-virtualization scale deploy/virt-operator --replicas=0
        sleep 2
        kubectl -n d8-virtualization scale deploy/virt-operator --replicas=1
      - |
        echo "Watch for deploy/virt-controller"
        kubectl -n d8-virtualization get --watch-only deploy/virt-controller
