---
{{- $versionLibvirt := "10.10.0" }}
{{- $gitRepoUrl := "https://github.com/libvirt/libvirt.git" }}
{{- $gitRepoName := "libvirt" }}

image: {{ $.ImageName }}
final: false
fromImage: base-alt-p11
git:
- add: /images/{{ $.ImageName }}/
  to: /
  includePaths:
  - install-libvirt.sh
  stageDependencies:
    setup:
      - install-libvirt.sh
shell:
  beforeInstall:
  - | 
    apt-get update && apt-get install --yes \
    binutils \
    dmidecode \
    gcc-c++ \
    git \
    gettext \
    bash-completion \
    clang \
    ccache \
    make cmake \
    meson \
    ninja-build \
    libudev-devel \
    libpciaccess-devel \
    libyajl-devel \
    sanlock-devel \
    libpcap-devel \
    libnl-devel \
    libselinux-devel \
    iproute \
    iptables \
    iptables-nft \
    iptables-ipv6 \
    openvswitch \
    ebtables \
    libsasl2-devel \
    pkgconfig \
    libssh-devel \
    libssh2-devel \
    polkit kmod \
    qemu-img \
    lvm2 \
    libparted-devel \
    parted \
    libdevmapper-devel \
    ceph-devel \
    open-iscsi \
    libiscsi-devel \
    libglusterfs-devel \
    libnuma-devel \
    libcap-ng-devel \
    libcurl-devel \
    libaudit-devel \
    libfuse-devel \
    libnbd-devel \
    libblkid-devel \
    libgcrypt-devel \
    libgnutls-devel \
    libp11-kit-devel \
    libreadline-devel \
    libtasn1-devel \
    libattr-devel \
    libbsd-devel \
    libsystemd-devel \
    libuuid-devel \
    libjson-c-devel \
    systemtap-sdt-devel \
    systemd-container \
    attr \
    libacl-devel \
    glib2-devel \
    glibc-utils \
    libgio-devel \
    libxml2-devel \
    xml-utils \
    xsltproc \
    python3 python3-devel \
    python3-module-pytest \
    python3-module-docutils \
    python3-tools \
    python3-module-pip \
    polkit \
    libtirpc-devel \
    libsasl2-devel \
    wireshark-devel \
    tshark \
    zlib-devel \
    mdevctl \
    util-linux dmsetup pm-utils libclocale \
    libfuse3-devel libnuma libslirp-devel \
    libyajl-devel libselinux-devel

    apt-get clean
    rm --recursive --force /var/lib/apt/lists/ftp.altlinux.org* /var/cache/apt/*.bin

    rm -f /usr/lib*/python3*/EXTERNALLY-MANAGED
    rpm -qa | sort > /packages.txt
    mkdir -p /usr/libexec/ccache-wrappers
    ln -s /usr/bin/ccache /usr/libexec/ccache-wrappers/cc
    ln -s /usr/bin/ccache /usr/libexec/ccache-wrappers/clang
    ln -s /usr/bin/ccache /usr/libexec/ccache-wrappers/gcc
  
    pip3 install black
    grep -qw ^rpm /etc/group || groupadd rpm
    id -u builder &>/dev/null || useradd builder --shell /bin/bash --create-home --group rpm

  install:
  - |
    # export CCACHE_WRAPPERSDIR="/usr/libexec/ccache-wrappers"
    # export PATH="$CCACHE_WRAPPERSDIR:$PATH"
    export MAKE="/usr/bin/make"
    export NINJA="/usr/bin/ninja"
    export PYTHON="/usr/bin/python3"

    git clone --depth=1 --branch v{{ $versionLibvirt }} {{ $gitRepoUrl }} {{ $gitRepoName }}-{{ $versionLibvirt }}

    cd {{ $gitRepoName }}-{{ $versionLibvirt }}

    CFLAGS="-Wframe-larger-than=262144" meson setup build \
      -Ddriver_qemu=enabled \
      -Ddriver_openvz=disabled \
      -Ddriver_lxc=disabled -Dlogin_shell=disabled \
      -Ddriver_vbox=disabled \
      -Ddriver_libxl=disabled \
      -Dsasl=enabled \
      -Dpolkit=enabled \
      -Ddriver_libvirtd=enabled \
      -Ddriver_remote=enabled \
      -Ddriver_test=disabled \
      -Ddriver_esx=disabled -Dcurl=disabled \
      -Ddriver_hyperv=disabled -Dopenwsman=disabled \
      -Ddriver_vmware=disabled \
      -Ddriver_vz=disabled \
      -Ddriver_bhyve=disabled \
      -Ddriver_ch=disabled \
      -Dremote_default_mode=direct \
      -Ddriver_interface=enabled \
      -Ddriver_network=enabled \
      -Dstorage_fs=disabled \
      -Dstorage_lvm=disabled \
      -Dstorage_iscsi=disabled \
      -Dstorage_iscsi_direct=disabled -Dlibiscsi=disabled \
      -Dstorage_scsi=disabled \
      -Dstorage_disk=disabled \
      -Dstorage_mpath=disabled \
      -Dstorage_rbd=disabled \
      -Dstorage_gluster=disabled -Dglusterfs=disabled \
      -Dstorage_zfs=disabled \
      -Dstorage_vstorage=disabled \
      -Dnumactl=enabled \
      -Dnumad=disabled \
      -Dcapng=enabled \
      -Dfuse=enabled \
      -Dnetcf=disabled \
      -Dnls=enabled \
      -Dapparmor=disabled \
      -Dapparmor_profiles=disabled \
      -Dsecdriver_apparmor=disabled \
      -Dudev=enabled \
      -Djson_c=enabled \
      -Dsanlock=disabled \
      -Dlibpcap=enabled \
      -Dnbdkit=disabled -Dnbdkit_config_default=disabled \
      -Dlibnl=enabled \
      -Daudit=enabled \
      -Ddtrace=disabled \
      -Dfirewalld=enabled \
      -Dfirewalld_zone=enabled \
      -Dwireshark_dissector=disabled \
      -Dlibssh=enabled -Dlibssh2=enabled \
      -Dpm_utils=disabled \
      -Dnss=enabled \
      -Dqemu_user="qemu" \
      -Dqemu_group="qemu" \
      -Dsysctl_config=enabled \
      -Dssh_proxy=enabled \
      -Dinit_script=systemd \
      -Dfirewall_backend_priority="iptables,nftables" \
      -Ddocs=disabled \
      -Dtests=disabled \
      -Drpath=disabled

    ninja -C build -j$(nproc)

    # -Dselinux=enabled -Dselinux_mount="/sys/fs/selinux" \
    # -Dtls_priority="@LIBVIRT,SYSTEM" \
    # -Duserfaultfd_sysctl=disabled \

  setup:
  - |    
    /install-libvirt.sh -s /{{ $gitRepoName }}-{{ $versionLibvirt }} \
                        -d /BINS \
                        -b build
