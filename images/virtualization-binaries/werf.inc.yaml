---
image: swtpm
final: false
from: {{ .Images.BASE_SCRATCH }}
import:
- image: {{ $.ImageName }}-builder
  add: /relocate
  to: /
  before: setup

---
{{- $version := "0.10.0" }}

{{- $name := print $.ImageName "-dependencies" -}}
{{- define "$name" -}}
packages:
# libtpms libtpms-devel requares 0.10 ver which in sisyphus repo
- expect socat twisted-core-tools gcc
- git pkg-config trousers
- automake autoconf make gcc
- openssl cryptote
- net-tools softhsm
- tpm2-pkcs11 tpm2-pkcs11-tools tpm2-tools tpm2-abrmd
- libtool
- glib2-devel libgnutls-openssl-devel libssl-devel
- libgnutls30 libfuse-devel libgnutls-devel gnutls-utils
- libtasn1 libtasn1-devel libjson-glib-devel
- libseccomp-devel libseccomp
- libgmp-devel
- perl-podlators
binaries:
- /usr/bin/swtpm_bios
- /usr/bin/swtpm_ioctl
- /usr/bin/swtpm_cert
- /usr/bin/swtpm
- /usr/bin/swtpm_setup
- /usr/bin/swtpm_localca
- /usr/bin/swtpm_cuse
- /usr/lib64/swtpm/libswtpm_libtpms.a
- /usr/lib64/swtpm/libswtpm_libtpms.so
- /usr/lib64/swtpm/libswtpm_libtpms.so.0.0.0
- /usr/lib64/swtpm/libswtpm_libtpms.la
- /usr/lib64/swtpm/libswtpm_libtpms.so.0
- /usr/lib64/libtss2-tcti-swtpm.so.0
- /usr/lib64/libtss2-tcti-swtpm.so.0.0.0
{{- end -}}

{{ $builderDependencies := include "$name" . | fromYaml }}

image: {{ $.ImageName }}-builder
final: false
fromImage: base-alt-p11-binaries
shell:
  beforeInstall:
    - |
      apt-get update && apt-get install -y \
        {{ $builderDependencies.packages | join " " }}
      
      cat >/etc/apt/sources.list.d/alt-sisyphus.list<<EOF 
      rpm [alt] http://ftp.altlinux.org/pub/distributions/ALTLinux/Sisyphus x86_64 classic
      rpm [alt] http://ftp.altlinux.org/pub/distributions/ALTLinux/Sisyphus noarch classic
      EOF
      apt-get update
      apt-get install -y libtpms-devel
      rm -f /etc/apt/sources.list.d/alt-sisyphus.list

      apt-get update
      apt-get clean
      rm --recursive --force /var/lib/apt/lists/ftp.altlinux.org* /var/cache/apt/*.bin

  install:
    - |
      git clone --depth=1 --branch v{{ $version }} {{ $.SOURCE_REPO }}/stefanberger/swtpm.git /swtpm
      cd /swtpm
      ./autogen.sh --with-openssl --prefix=/usr --libdir=/usr/lib64
      make -j$(nproc)
      make install

  setup:
    - |
      /relocate_binaries.sh -i "{{ $builderDependencies.binaries | join " " }}" -o /relocate
      mkdir -p /relocate/usr/include/swtpm
      cp -an /usr/include/swtpm/. /relocate/usr/include/swtpm
