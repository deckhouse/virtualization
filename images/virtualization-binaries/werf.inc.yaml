---
image: swtpm
final: false
from: {{ .Images.BASE_SCRATCH }}
import:
- image: {{ $.ImageName }}-builder
  add: /relocate
  to: /out
  before: setup

---
{{- $version := "0.10.0" }}

{{- $name := print $.ImageName "-dependencies" -}}
{{- define "$name" -}}
packages:
- autoconf automake bash expect gawk gnutls gnutls-dev gnutls-utils
- json-glib-dev libseccomp-dev libtasn1-dev libtool libtpms-dev openssl-dev
- python3 socat
binaries:
- /usr/bin/swtpm_bios
- /usr/bin/swtpm_ioctl
- /usr/bin/swtpm_cert
- /usr/bin/swtpm
- /usr/bin/swtpm_setup
- /usr/bin/swtpm_localca
- /usr/bin/swtpm_cuse
- /usr/lib64/swtpm/libswtpm_libtpms.a
- /usr/lib64/swtpm/libswtpm_libtpms.so
- /usr/lib64/swtpm/libswtpm_libtpms.so.0.0.0
- /usr/lib64/swtpm/libswtpm_libtpms.la
- /usr/lib64/swtpm/libswtpm_libtpms.so.0
- /usr/lib64/libtss2-tcti-swtpm.so.0
- /usr/lib64/libtss2-tcti-swtpm.so.0.0.0
{{- end -}}

{{ $builderDependencies := include "$name" . | fromYaml }}

image: {{ $.ImageName }}-builder
final: false
from: alpine:3.20.6
# fromImage: alpine-builder
secrets:
- id: SOURCE_REPO
  value: {{ $.SOURCE_REPO }}
shell:
  beforeInstall:
    - |
      apk update
      apk add -y {{ $builderDependencies.packages | join " " }}

  install:
    - |
      git clone --depth=1 --branch v{{ $version }} $(cat /run/secrets/SOURCE_REPO)/stefanberger/swtpm.git /swtpm
      cd /swtpm
      ./autogen.sh --with-openssl --prefix=/usr --libdir=/usr/lib64
      CC="/usr/bin/musl-gcc" LDFLAGS="-static" make -j$(nproc)
      make install

  setup:
    - |
      /relocate_binaries.sh -i "{{ $builderDependencies.binaries | join " " }}" -o /relocate
      mkdir -p /relocate/usr/include/swtpm
      cp -an /usr/include/swtpm/. /relocate/usr/include/swtpm
