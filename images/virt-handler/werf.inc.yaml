---
image: {{ .ModuleNamePrefix }}{{ .ImageName }}
fromImage: {{ .ModuleNamePrefix }}distroless
git:
  {{- include "image mount points" . }}
import:
- image: {{ .ModuleNamePrefix }}{{ .ImageName }}-bins
  add: /relocate
  to: /
  after: install
# GNU utilities
# deps for 031-hotplug-container-disk.patch
- image: tools/coreutils
  add: /
  to: /
  after: install
  includePaths:
  - usr/bin/cp
  - usr/bin/coreutils
- image: {{ .ModuleNamePrefix }}virt-artifact
  add: /kubevirt-binaries/
  to: /usr/bin
  after: install
  includePaths:
  - virt-chroot
  - virt-handler
  - container-disk
- image: {{ .ModuleNamePrefix }}virt-artifact
  add: /kubevirt-config-files/.version
  to: /.version
  after: install
  includePaths:
  - .version
- image: {{ .ModuleNamePrefix }}virt-artifact
  add: /kubevirt/cmd/{{ $.ImageName }}/
  to: /etc
  after: install
  includePaths:
  - nsswitch.conf
{{- if eq $.DEBUG_COMPONENT "delve/virt-handler" }}
- image: debugger
  add: /app/dlv
  to: /app/dlv
  after: install
{{- end }}
# Source https://github.com/kubevirt/kubevirt/blob/v1.3.1/cmd/virt-handler/BUILD.bazel
imageSpec:
  config:
    user: 0
    {{- if eq $.DEBUG_COMPONENT "delve/virt-handler" }}
    env:
      PATH: "/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/app/dlv"
      XDG_CONFIG_HOME: "/tmp"
    entrypoint: ["/app/dlv", "--listen=:2345", "--headless=true", "--continue", "--log=true", "--log-output=debugger,debuglineerr,gdbwire,lldbout,rpc", "--accept-multiclient", "--api-version=2", "exec", "/usr/bin/virt-handler", "--"]
    {{- else }}
    entrypoint: ["/usr/bin/virt-handler"]
    {{- end }}

---
{{- $name := print $.ImageName "-dependencies" -}}
{{- define "$name" -}}
binaries:
- /usr/bin/getfacl
- /usr/bin/setfacl
- /usr/sbin/nft
- /usr/bin/xorriso
- /usr/bin/xorrecord
- /usr/bin/osirrox
- /usr/bin/xorriso-dd-target
- /usr/bin/xorrisofs
packages:
- libisoburn nftables acl libmnl libjansson4 libnftnl
- glibc libattr pcre2 selinux
- libaio libaudit libcap-ng numactl
- linux-pam libunistring libgmp gnutls nettle libidn2 p11-kit libtasn1
- libffi zlib zstd liburing glib2 libfuse3 libburn readline libisofs ncurses
{{- end -}}

{{ $builderDependencies := include "$name" . | fromYaml }}

image: {{ .ModuleNamePrefix }}{{ .ImageName }}-bins
final: false
fromImage: {{ .ModuleNamePrefix }}base-alt-p11-binaries
import:
- image: tools/util-linux
  add: /
  to: /relocate/usr
  after: setup
  includePaths:
  - bin/mount
  - bin/umount
{{- include "importPackageImages" (list . $builderDependencies.packages "install") -}}
- image: {{ .ModuleNamePrefix }}qemu
  add: /qemu-img
  to: /relocate
  before: setup
shell:
  install:
  - |
    # Install packages
    PKGS="{{ $builderDependencies.packages | join " " }}"
    for pkg in $PKGS; do
      cp -a /$pkg/. /
      rm -rf /$pkg
    done

  setup:
  - |
    /relocate_binaries.sh -i "{{ $builderDependencies.binaries | join " " }}" -o /relocate

    mkdir -p /relocate/etc /relocate/root
    echo "root:x:0:0:root:/root:/bin/bash" >> /relocate/etc/passwd
    echo "root:x:0:" >> /relocate/etc/group
    echo "root:x:::::::" >> /relocate/etc/shadow

    echo "qemu:x:107:107::/home/qemu:/bin/bash" >> /relocate/etc/passwd
    echo "qemu:x:107:" >> /relocate/etc/group
    mkdir -p /relocate/home/qemu
    chown -R 107:107 /relocate/home/qemu

