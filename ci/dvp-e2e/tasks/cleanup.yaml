version: "3"

tasks:
  cleanup:namespaces:
    desc: Cleanup test namespaces
    vars:
      FILTER_PREFIX: '{{ .FILTER_PREFIX | default "nightly-nested-e2e-" }}'
    env:
      KUBECONFIG: "{{ .KUBECONFIG }}"
    cmds:
      - |
        echo "ðŸ§¹ Cleaning up namespaces with prefix: {{ .FILTER_PREFIX }}"
        
        kubectl get namespaces -o name | grep "{{ .FILTER_PREFIX }}" | while read ns; do
          ns_name=$(echo "$ns" | cut -d/ -f2)
          echo "Deleting namespace: $ns_name"
          kubectl delete namespace "$ns_name" --wait=false || true
        done
        
        echo "Waiting for namespace deletions to complete..."
        kubectl get namespaces -o name | grep "{{ .FILTER_PREFIX }}" | while read ns; do
          ns_name=$(echo "$ns" | cut -d/ -f2)
          kubectl wait --for=delete namespace/"$ns_name" --timeout=600s || true
        done
        
        echo "âœ… Cleanup completed"

