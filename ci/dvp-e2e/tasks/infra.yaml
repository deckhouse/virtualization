version: "3"

tasks:
  # ============================================
  # Infrastructure Tasks
  # ============================================

  infra:ceph:bootstrap:
    desc: Bootstrap Rook Ceph CRDs/operator in nested cluster
    vars:
      NESTED_KUBECONFIG: "{{ .NESTED_KUBECONFIG }}"
    cmds:
      - ./scripts/ceph-bootstrap.sh {{ .NESTED_KUBECONFIG }}

  infra:storage:prepare:
    desc: Prepare storage infrastructure for testing
    vars:
      STORAGE_PROFILE: "{{ .STORAGE_PROFILE }}"
      NESTED_KUBECONFIG: "{{ .NESTED_KUBECONFIG }}"
    cmds:
      - |
        case "{{ .STORAGE_PROFILE }}" in
          cephrbd)
            task: infra:ceph:bootstrap
            ;;
          sds|sds-local|hostpath)
            echo "Using {{ .STORAGE_PROFILE }} storage profile"
            ;;
          *)
            echo "Unknown storage profile: {{ .STORAGE_PROFILE }}"
            exit 1
            ;;
        esac

  infra:registry:setup:
    desc: Setup container registry configuration
    vars:
      REGISTRY_DOCKER_CFG: "{{ .REGISTRY_DOCKER_CFG }}"
      TMP_DIR: "{{ .TMP_DIR }}"
    cmds:
      - mkdir -p {{ .TMP_DIR }}
      - |
        if [ -n "{{ .REGISTRY_DOCKER_CFG }}" ]; then
          echo "{{ .REGISTRY_DOCKER_CFG }}" | base64 -d > {{ .TMP_DIR }}/docker_config.json
          echo "Registry configuration saved"
        else
          echo "No registry configuration provided"
        fi

  infra:network:prepare:
    desc: Prepare network configuration
    vars:
      RUN_ID: "{{ .RUN_ID }}"
      RUN_DOMAIN: "{{ .RUN_DOMAIN }}"
    cmds:
      - |
        echo "Preparing network for run: {{ .RUN_ID }}"
        echo "Domain: {{ .RUN_DOMAIN }}"
        # Network preparation logic can be added here

  infra:monitoring:setup:
    desc: Setup monitoring and observability
    vars:
      NESTED_KUBECONFIG: "{{ .NESTED_KUBECONFIG }}"
    cmds:
      - |
        echo "Setting up monitoring for cluster"
        # Monitoring setup logic can be added here
